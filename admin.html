<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>JARVIA Admin</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&family=Poppins:wght@600;700;800&display=swap" rel="stylesheet">
  <style>
:root{--primary:#1B3A5C;--primary-lt:#2E5A88;--primary-dk:#0F2440;--accent:#2E86AB;--accent-lt:#48A6CB;--accent-glow:rgba(46,134,171,.15);--success:#27AE60;--warning:#F39C12;--danger:#E74C3C;--bg:#F7F9FC;--bg-card:#FFF;--text:#2C3E50;--text-lt:#7F8C8D;--border:#E1E8EE;--border-lt:#F0F3F6;--shadow:0 2px 12px rgba(27,58,92,.08);--shadow-lg:0 8px 32px rgba(27,58,92,.12);--radius:10px;--radius-lg:16px;--tr:.25s cubic-bezier(.4,0,.2,1);--font:'Noto Sans KR',-apple-system,BlinkMacSystemFont,sans-serif;--font-d:'Poppins','Noto Sans KR',sans-serif}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}html{scroll-behavior:smooth;overflow-x:hidden}body{font-family:var(--font);background:var(--bg);color:var(--text);line-height:1.6;min-height:100vh;-webkit-font-smoothing:antialiased;overflow-x:hidden}
.header{position:fixed;top:0;left:0;right:0;z-index:100;background:var(--primary-dk);border-bottom:1px solid rgba(255,255,255,.08);overflow:hidden}.header-inner{max-width:1400px;margin:0 auto;padding:0 24px;height:60px;display:flex;align-items:center;justify-content:space-between;overflow:hidden}.logo{text-decoration:none;display:flex;align-items:baseline;gap:8px}.logo-text{font-family:var(--font-d);font-size:24px;font-weight:800;color:#fff;letter-spacing:-.5px}.logo-sub{font-size:11px;color:rgba(255,255,255,.5);font-weight:300}.header-nav{display:flex;align-items:center;gap:8px}.btn-h{background:none;border:1px solid rgba(255,255,255,.15);color:rgba(255,255,255,.8);padding:6px 14px;border-radius:6px;cursor:pointer;font-size:13px;transition:var(--tr);font-family:var(--font)}.btn-h:hover{background:rgba(255,255,255,.1);color:#fff}.btn-h-logout{border-color:rgba(231,76,60,.4);color:rgba(231,76,60,.8)}.btn-h-logout:hover{background:rgba(231,76,60,.15);color:#E74C3C}.hdr-name{color:rgba(255,255,255,.9);font-size:13px;font-weight:500;padding:0 4px}
.fg{margin-bottom:16px;flex:1}.fg label{display:block;font-size:13px;font-weight:500;color:var(--text);margin-bottom:6px}.fg label i{color:var(--danger);font-style:normal}.fg input,.fg select,.fg textarea{width:100%;padding:10px 14px;border:1px solid var(--border);border-radius:8px;font-size:14px;font-family:var(--font);transition:var(--tr);background:#fff;color:var(--text)}.fg input:focus,.fg select:focus,.fg textarea:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px var(--accent-glow)}.fr{display:flex;gap:16px}
.btn{background:var(--primary);color:#fff;border:none;padding:10px 24px;border-radius:8px;font-size:14px;font-weight:600;cursor:pointer;transition:var(--tr);font-family:var(--font)}.btn:hover{background:var(--primary-lt);transform:translateY(-1px);box-shadow:var(--shadow)}.btn:disabled{opacity:.5;cursor:not-allowed;transform:none}.btn-sec{background:#fff;color:var(--text);border:1px solid var(--border)}.btn-sec:hover{border-color:var(--primary);color:var(--primary);background:#fff}.btn-sm{padding:6px 12px;font-size:12px}.btn-danger{background:var(--danger);color:#fff;border:none;padding:6px 12px;border-radius:6px;font-size:12px;cursor:pointer}.btn-full{width:100%}.btn-success{background:var(--success)}.btn-warning{background:var(--warning);color:#333}
.badge{display:inline-block;padding:2px 8px;border-radius:4px;font-size:11px;font-weight:600}.badge-doc{background:#E8F5E9;color:#2E7D32}.badge-ppt{background:#FFF3E0;color:#E65100}.badge-html{background:#E3F2FD;color:#1565C0}.badge-video{background:#FCE4EC;color:#C62828}.badge-audio{background:#F3E5F5;color:#7B1FA2}.badge-brief{background:#E3F2FD;color:#1565C0}.badge-report{background:#E0F7FA;color:#00695C}.badge-closing{background:#FFF3E0;color:#E65100}.badge-closing-pdf{background:#FFEBEE;color:#C62828}.badge-closing-ppt{background:#FFF3E0;color:#E65100}.st-active{color:var(--success);font-weight:600}.st-suspended{color:var(--danger);font-weight:600}.st-expired{color:var(--danger);font-weight:600}.st-ok{color:var(--success);font-weight:600}.st-warn{color:var(--warning);font-weight:600}.st-new{background:#E3F2FD;color:#1565C0;padding:2px 8px;border-radius:4px;font-size:12px}.st-reviewing{background:#FFF3E0;color:#E65100;padding:2px 8px;border-radius:4px;font-size:12px}.st-done{background:#E8F5E9;color:#2E7D32;padding:2px 8px;border-radius:4px;font-size:12px}.st-jarvia{color:#D84315;font-weight:700}.st-inner{color:#4527A0;font-weight:700}
.tbl{width:100%;border-collapse:collapse;font-size:13px}.tbl th{background:var(--primary);color:#fff;padding:10px 12px;text-align:left;font-weight:500;white-space:nowrap}.tbl td{padding:10px 12px;border-bottom:1px solid var(--border-lt)}.tbl tbody tr:hover{background:var(--accent-glow)}.tbl .ov{max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.tbl-wrap{overflow-x:auto;-webkit-overflow-scrolling:touch;max-width:100%}
.tabs{display:flex;gap:4px;margin-bottom:20px;flex-wrap:wrap}.tab{padding:10px 20px;border:none;background:var(--border-lt);border-radius:8px 8px 0 0;cursor:pointer;font-size:14px;font-weight:500;color:var(--text-lt);transition:var(--tr);font-family:var(--font)}.tab.active{background:var(--primary);color:#fff}
.modal{position:fixed;inset:0;z-index:200;display:flex;align-items:center;justify-content:center}.mdl-bg{position:absolute;inset:0;background:rgba(0,0,0,.5);backdrop-filter:blur(4px)}.mdl-box{position:relative;background:var(--bg-card);border-radius:var(--radius-lg);padding:32px;max-width:500px;width:90%;max-height:90vh;overflow-y:auto;overflow-x:hidden;box-shadow:var(--shadow-lg);z-index:1}.mdl-lg{max-width:720px}.mdl-x{position:absolute;top:12px;right:16px;background:none;border:none;font-size:28px;color:var(--text-lt);cursor:pointer;z-index:2}
.toast{position:fixed;bottom:32px;left:50%;transform:translateX(-50%);background:var(--primary-dk);color:#fff;padding:12px 28px;border-radius:8px;font-size:14px;z-index:9999;box-shadow:var(--shadow-lg)}.toast-success{background:var(--success)}.toast-error{background:var(--danger)}.toast-warning{background:var(--warning);color:#333}
.adm-layout{display:flex;min-height:100vh;padding-top:60px;overflow-x:hidden}.sidebar{width:220px;background:var(--primary-dk);position:fixed;top:60px;left:0;bottom:0;overflow-y:auto;padding:12px 0;z-index:50;border-right:1px solid rgba(255,255,255,.05)}.side-nav{display:flex;flex-direction:column}.sn{color:rgba(255,255,255,.65);text-decoration:none;padding:10px 20px;font-size:13px;transition:var(--tr);border-left:3px solid transparent;cursor:pointer}.sn:hover{color:#fff;background:rgba(255,255,255,.05)}.sn.active{color:#fff;background:rgba(46,134,171,.15);border-left-color:var(--accent)}.adm-main{flex:1;margin-left:220px;padding:24px;min-height:calc(100vh - 60px);overflow-x:hidden;max-width:calc(100vw - 220px)}.panel{overflow-x:hidden}.panel h2{font-size:22px;font-weight:600;color:var(--primary);margin-bottom:20px;padding-bottom:12px;border-bottom:2px solid var(--border-lt)}.toolbar{display:flex;gap:8px;margin-bottom:16px;align-items:center;flex-wrap:wrap;max-width:100%}.toolbar input,.toolbar select{padding:8px 12px;border:1px solid var(--border);border-radius:6px;font-size:13px;font-family:var(--font);min-width:0}.toolbar label{font-size:13px;color:var(--text-lt)}.form-box{background:var(--bg);padding:20px;border-radius:var(--radius);margin:16px 0;border:1px solid var(--border-lt);overflow-x:hidden}.info-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-bottom:16px;font-size:13px;overflow-wrap:break-word;word-break:break-all}.info-grid label{color:var(--text-lt);margin-right:8px}
.dash-row{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:24px;max-width:100%}.dash-c{background:var(--bg-card);border-radius:var(--radius);padding:20px;box-shadow:var(--shadow);border-left:4px solid var(--accent);overflow:hidden}.dash-c span{font-size:13px;color:var(--text-lt);display:block;margin-bottom:8px}.dash-c strong{font-size:28px;color:var(--primary);font-weight:700}.dash-c em{font-size:13px;color:var(--text-lt);font-style:normal}
.hidden{display:none!important}.empty{text-align:center;padding:48px;color:var(--text-lt);font-size:15px}.mt{margin-top:16px}
.rich-toolbar{display:flex;gap:4px;flex-wrap:wrap;margin-bottom:4px;padding:8px;background:var(--border-lt);border:1px solid var(--border);border-bottom:none;border-radius:6px 6px 0 0;align-items:center}.rich-toolbar .tb-sep{color:var(--border);font-size:16px;margin:0 2px;user-select:none}.rich-editor{min-height:200px;border:1px solid var(--border);border-radius:0 0 6px 6px;padding:16px;font-size:14px;line-height:1.8;background:#fff;outline:none;overflow-y:auto}.rich-editor:focus{border-color:var(--accent);box-shadow:0 0 0 3px var(--accent-glow)}.rich-editor img{max-width:100%;height:auto;border-radius:4px;margin:8px 0}.rich-editor h2{font-size:20px;color:var(--primary);margin:12px 0 6px}.rich-editor h3{font-size:17px;color:var(--primary-lt);margin:10px 0 4px}
.mob-menu-btn{display:none;background:none;border:none;color:#fff;font-size:24px;cursor:pointer}
.mob-adm-header{display:none;padding:16px 20px;background:rgba(46,134,171,.1);border-bottom:1px solid rgba(255,255,255,.08)}.mob-adm-header .mob-adm-name{color:rgba(255,255,255,.9);font-size:13px;font-weight:500;display:block;margin-bottom:10px}.mob-adm-header .mob-adm-btns{display:flex;gap:8px}.mob-adm-header .mob-adm-btns button{flex:1;padding:8px 0;border-radius:6px;font-size:13px;font-family:var(--font);cursor:pointer;transition:var(--tr)}.mob-adm-header .btn-user-page{background:none;border:1px solid rgba(255,255,255,.2);color:rgba(255,255,255,.8)}.mob-adm-header .btn-user-page:hover{background:rgba(255,255,255,.1);color:#fff}.mob-adm-header .btn-mob-logout{background:none;border:1px solid rgba(231,76,60,.4);color:rgba(231,76,60,.8)}.mob-adm-header .btn-mob-logout:hover{background:rgba(231,76,60,.15);color:#E74C3C}
@media(max-width:768px){.header-nav{display:none}.mob-menu-btn{display:block}.mob-adm-header{display:block}.fr{flex-direction:column;gap:0}.tbl{font-size:12px}.tbl th,.tbl td{padding:8px 6px}.mdl-box{padding:20px;width:95%}.dash-row{grid-template-columns:repeat(2,1fr)}.sidebar{display:none;position:fixed;z-index:999;width:100%}.sidebar.show{display:block}.adm-main{margin-left:0;padding:16px;max-width:100vw;overflow-x:hidden}.info-grid{grid-template-columns:1fr}.toolbar input,.toolbar select{width:100%;flex:1 1 auto}.toolbar{flex-direction:column;align-items:stretch}.panel{overflow-x:hidden}.header-inner{overflow:hidden}.tabs{overflow-x:auto;-webkit-overflow-scrolling:touch;flex-wrap:nowrap}.tab{white-space:nowrap;flex-shrink:0}.form-box{overflow-x:hidden}.dash-c strong{font-size:22px}.rich-toolbar{gap:3px;padding:6px}.rich-toolbar .btn-sm{padding:4px 8px;font-size:11px}.rich-toolbar select{font-size:11px}.rich-editor{min-height:150px;padding:12px;font-size:13px}}
  </style>
</head>
<body>
<header class="header"><div class="header-inner"><a href="admin.html" class="logo"><span class="logo-text">JARVIA</span><span class="logo-sub">Admin</span></a><nav class="header-nav"><span id="adm-name" class="hdr-name"></span><button class="btn-h" onclick="window.open('index.html?view=1','_blank')">ì‚¬ìš©ì í˜ì´ì§€</button><button class="btn-h btn-h-logout" onclick="admLogout()">ë¡œê·¸ì•„ì›ƒ</button></nav><button class="mob-menu-btn" onclick="document.querySelector('.sidebar').classList.toggle('show')">â˜°</button></div></header>
<div class="adm-layout">
  <aside class="sidebar">
    <div class="mob-adm-header" id="mob-adm-header">
      <span class="mob-adm-name" id="mob-adm-name"></span>
      <div class="mob-adm-btns">
        <button class="btn-user-page" onclick="window.open('index.html?view=1','_blank')">ì‚¬ìš©ì í˜ì´ì§€</button>
        <button class="btn-mob-logout" onclick="admLogout()">ë¡œê·¸ì•„ì›ƒ</button>
      </div>
    </div>
    <nav class="side-nav">
    <a class="sn active" data-p="p-dash" onclick="goPanel(this)">ğŸ“Š ëŒ€ì‹œë³´ë“œ</a>
    <a class="sn" data-p="p-members" onclick="goPanel(this)">ğŸ‘¥ íšŒì›ê´€ë¦¬</a>
    <a class="sn" data-p="p-admins" onclick="goPanel(this)">ğŸ”‘ ê´€ë¦¬ìê´€ë¦¬</a>
    <a class="sn" data-p="p-contents" onclick="goPanel(this)">ğŸ“ ì½˜í…ì¸ ê´€ë¦¬</a>
    <a class="sn" data-p="p-cats" onclick="goPanel(this)">ğŸ· ì¹´í…Œê³ ë¦¬ê´€ë¦¬</a>
    <a class="sn" data-p="p-pays" onclick="goPanel(this)">ğŸ’³ ê²°ì œ/ì¶©ì „ê´€ë¦¬</a>
    <a class="sn" data-p="p-logs" onclick="goPanel(this)">ğŸ“‹ ì´ìš©ë¡œê·¸/ì •ì‚°</a>
    <a class="sn" data-p="p-props" onclick="goPanel(this)">ğŸ¤ ì œíœ´ì œì•ˆí•¨</a>
    <a class="sn" data-p="p-notices" onclick="goPanel(this)">ğŸ“¢ ê³µì§€ì‚¬í•­ê´€ë¦¬</a>
    <a class="sn" data-p="p-guide" onclick="goPanel(this)">ğŸ“– ê°€ì´ë“œê´€ë¦¬</a>
    <a class="sn" data-p="p-terms" onclick="goPanel(this)">ğŸ“ ì•½ê´€ê´€ë¦¬</a>
    <a class="sn" data-p="p-chargeopt" onclick="goPanel(this)">âš™ï¸ ì¶©ì „ê¸ˆì•¡ì„¤ì •</a>
    <a class="sn" data-p="p-thumbs" onclick="goPanel(this)">ğŸ¨ ì¸ë„¤ì¼ì„¤ì •</a>
    <a class="sn" data-p="p-referral-set" onclick="goPanel(this)">ğŸ¯ ì¶”ì²œì„¤ì •</a>
    <a class="sn" data-p="p-referral-status" onclick="goPanel(this)">ğŸ“ˆ ì¶”ì²œí˜„í™©</a>
    <a class="sn" data-p="p-upcoming" onclick="goPanel(this)">ğŸ“… ê²Œì‹œì˜ˆì •ì½˜í…ì¸ </a>
    <a class="sn" data-p="p-popups" onclick="goPanel(this)">ğŸ”” íŒì—…ê´€ë¦¬</a>
    <a class="sn" data-p="p-pptgen" onclick="goPanel(this)">ğŸ¤– PPTìƒì„±ê´€ë¦¬</a>
  </nav></aside>
  <main class="adm-main">
    <div id="p-dash" class="panel"><h2>ëŒ€ì‹œë³´ë“œ</h2><div class="dash-row"><div class="dash-c"><span>ì˜¤ëŠ˜ ê°€ì…</span><strong id="d-signup">0</strong></div><div class="dash-c"><span>ì˜¤ëŠ˜ ì—´ëŒ</span><strong id="d-views">0</strong></div><div class="dash-c"><span>ì˜¤ëŠ˜ ë§¤ì¶œ</span><strong id="d-rev">0</strong><em>ì›</em></div><div class="dash-c"><span>ì „ì²´ íšŒì›</span><strong id="d-total">0</strong></div></div><div class="dash-row"><div class="dash-c" style="border-left-color:#E65100"><span>ì˜¤ëŠ˜ PPT ìƒì„±</span><strong id="d-pptgen">0</strong><em>ê±´</em></div><div class="dash-c" style="border-left-color:#E65100"><span>ì˜¤ëŠ˜ PPT ë§¤ì¶œ</span><strong id="d-pptrev">0</strong><em>ì›</em></div></div></div>
    <div id="p-members" class="panel hidden"><h2>íšŒì›ê´€ë¦¬</h2>
      <button class="btn" onclick="showAddUser()">ë¬´ë£Œì‚¬ìš©ì ì¶”ê°€</button>
      <div id="add-user-form" class="hidden form-box">
        <div class="fr"><div class="fg"><label>ì´ë¦„ <i>*</i></label><input id="nu-name" required data-next="nu-loginid"></div><div class="fg"><label>ì•„ì´ë”” <i>*</i></label><input id="nu-loginid" required data-next="nu-pw"></div></div>
        <div class="fr"><div class="fg"><label>ë¹„ë°€ë²ˆí˜¸ <i>*</i></label><input id="nu-pw" type="password" required data-next="nu-email-id"></div><div class="fg"><label>ì´ë©”ì¼ <i>*</i></label><div style="display:flex;gap:4px;align-items:center;flex-wrap:wrap"><input id="nu-email-id" style="flex:1;min-width:80px" placeholder="ì•„ì´ë””" data-next="nu-company"><span>@</span><input id="nu-email-domain" style="flex:1;min-width:80px" placeholder="ì§ì ‘ì…ë ¥"><select id="nu-email-sel" style="flex:1;min-width:100px" onchange="nuEmailSel()"><option value="">ì§ì ‘ì…ë ¥</option><option value="naver.com">naver.com</option><option value="gmail.com">gmail.com</option><option value="daum.net">daum.net</option><option value="hanmail.net">hanmail.net</option><option value="kakao.com">kakao.com</option><option value="nate.com">nate.com</option><option value="hotmail.com">hotmail.com</option></select></div></div></div>
        <div class="fr"><div class="fg"><label>ì†Œì†ì‚¬</label><input id="nu-company" data-next="nu-title"></div><div class="fg"><label>ì§í•¨</label><input id="nu-title" data-next="nu-ph2"></div></div>
        <div class="fr"><div class="fg"><label>ì—°ë½ì²˜</label><div style="display:flex;gap:4px;align-items:center;flex-wrap:wrap"><input id="nu-ph1" value="010" style="width:60px;text-align:center;flex-shrink:0" readonly><span>-</span><input id="nu-ph2" inputmode="numeric" pattern="[0-9]*" maxlength="4" style="width:70px;text-align:center;flex-shrink:0" placeholder="0000" data-next="nu-ph3"><span>-</span><input id="nu-ph3" inputmode="numeric" pattern="[0-9]*" maxlength="4" style="width:70px;text-align:center;flex-shrink:0" placeholder="0000" data-next="nu-start"></div></div><div class="fg"><label>ì´ìš©ê¸°ê°„</label><div style="display:flex;gap:6px;align-items:center;flex-wrap:wrap"><input id="nu-start" type="date" style="width:140px;min-width:0;flex-shrink:1" data-next="nu-end"><span>~</span><input id="nu-end" type="date" style="width:140px;min-width:0;flex-shrink:1"><label style="margin-left:8px;font-size:13px;cursor:pointer"><input type="checkbox" id="nu-unlimited" onchange="nuUnlimitedChk()"> ë¬´ì œí•œ</label></div></div></div>
        <button class="btn" onclick="createFreeUser()">ìƒì„±</button> <button class="btn btn-sec" onclick="document.getElementById('add-user-form').classList.add('hidden')">ì·¨ì†Œ</button>
      </div>
      <div class="toolbar mt"><input id="m-search" placeholder="ì´ë¦„/ì—°ë½ì²˜/ì´ë©”ì¼ ê²€ìƒ‰..." oninput="window._mPage=1;loadMembers()"> <button class="btn btn-danger" onclick="deleteSelectedMembers()" style="margin-left:8px">ì„ íƒ ì‚­ì œ</button></div><div class="tbl-wrap"><table class="tbl"><thead><tr><th style="width:40px"><input type="checkbox" id="m-chk-all" onchange="toggleAllMembers()"></th><th style="width:40px">No.</th><th>ê°€ì…ì¼</th><th>íšŒì›ìœ í˜•</th><th>ì´ë¦„</th><th>ì•„ì´ë””</th><th>ì†Œì†</th><th>ì—°ë½ì²˜</th><th>ì´ìš©ë§Œë£Œ</th><th>ì”ì•¡</th><th>í¬ì¸íŠ¸</th><th>ì •ê¸°ê²°ì œ</th><th>ìƒíƒœ</th><th>ì¶”ì²œì¸</th><th>ê´€ë¦¬</th></tr></thead><tbody id="tb-members"></tbody></table></div><div id="m-pagination" style="display:flex;justify-content:center;align-items:center;gap:8px;margin:16px 0;flex-wrap:wrap"></div></div>
    <div id="p-admins" class="panel hidden"><h2>ê´€ë¦¬ì ê´€ë¦¬</h2><button class="btn" id="btn-add-adm" onclick="document.getElementById('add-adm-form').classList.toggle('hidden')">ê´€ë¦¬ì ì¶”ê°€</button><div id="add-adm-form" class="hidden form-box"><div class="fr"><div class="fg"><label>ì•„ì´ë””</label><input id="na-id"></div><div class="fg"><label>ì´ë¦„</label><input id="na-name"></div><div class="fg"><label>ë¹„ë°€ë²ˆí˜¸</label><input id="na-pw" type="password"></div></div><button class="btn" onclick="createAdmin()">ìƒì„±</button> <button class="btn btn-sec" onclick="document.getElementById('add-adm-form').classList.add('hidden')">ì·¨ì†Œ</button></div><div class="tbl-wrap"><table class="tbl mt"><thead><tr><th>ì•„ì´ë””</th><th>ì´ë¦„</th><th>ê¶Œí•œ</th><th>ë§ˆì§€ë§‰ ë¡œê·¸ì¸</th><th>ìƒíƒœ</th><th>ê´€ë¦¬</th></tr></thead><tbody id="tb-admins"></tbody></table></div></div>
    <div id="p-contents" class="panel hidden"><h2>ì½˜í…ì¸  ê´€ë¦¬</h2><button class="btn" onclick="showCF()">ì½˜í…ì¸  ë“±ë¡</button> <button class="btn btn-sec" onclick="syncGitHub()">ğŸ”„ GitHub ë™ê¸°í™”</button> <button class="btn btn-sec" onclick="showBatchUpload()">ğŸ“¦ ì¼ê´„ ë“±ë¡</button> <button class="btn btn-sec" onclick="toggleBulkPrice()">ğŸ’° ê°€ê²© ì¼ê´„ë³€ê²½</button>
    <div id="bulk-price-area" class="hidden form-box" style="margin-top:12px"><h3 style="margin-bottom:12px">ğŸ’° ê°€ê²© ì¼ê´„ë³€ê²½</h3><div class="fr"><div class="fg"><label>ê¸°ë³¸ ê°€ê²©(ì›) â€” ì˜ìƒ/ë¸Œë¦¬í•‘/ì˜¤ë””ì˜¤/ë³´ê³ ì„œ</label><input id="bp-default" type="number" value="2000" min="0" step="100"></div><div class="fg"><label>í´ë¡œì§•PPT ê°€ê²©(ì›)</label><input id="bp-closing" type="number" value="5000" min="0" step="100"></div></div><button type="button" class="btn" onclick="bulkPricePreview()">ë¯¸ë¦¬ë³´ê¸°</button> <button type="button" class="btn btn-sec" onclick="bulkPriceApply()">ì ìš©</button><div id="bp-result" style="margin-top:12px;font-size:13px"></div></div>
    <div id="sync-status" style="display:none;margin:12px 0;padding:12px;border-radius:8px;background:#f0f7ff;border:1px solid #c0d8f0;font-size:14px"></div>
    <div id="batch-area" class="hidden form-box"><h3 style="margin-bottom:12px">ğŸ“¦ ì¼ê´„ ë“±ë¡</h3>
      <div class="tabs" style="margin-bottom:16px"><button class="tab active" onclick="switchBatchTab('audio',this)">ğŸ§ ì˜¤ë””ì˜¤ ì¼ê´„</button><button class="tab" onclick="switchBatchTab('video',this)">ğŸ¬ ì˜ìƒ ì¼ê´„ (ì—‘ì…€)</button></div>
      <div id="batch-audio">
        <div class="fr"><div class="fg"><label>ì¹´í…Œê³ ë¦¬</label><select id="ba-cat"></select></div><div class="fg"><label>ê°€ê²©(ì›)</label><input id="ba-price" type="number" value="2000" min="0" step="100"></div></div>
        <div class="fg"><label>ì˜¤ë””ì˜¤ íŒŒì¼ ì„ íƒ (ë‹¤ì¤‘)</label><input type="file" id="ba-files" accept="audio/*" multiple onchange="previewAudioFiles()"></div>
        <div id="ba-preview" style="margin-top:12px"></div>
        <button type="button" class="btn mt" id="ba-upload-btn" onclick="batchAudioUpload()" style="display:none">ì—…ë¡œë“œ ë° ë“±ë¡</button>
        <div id="ba-progress" style="margin-top:12px"></div>
      </div>
      <div id="batch-video" style="display:none">
        <div class="fg"><label>ì—‘ì…€ íŒŒì¼ ì„ íƒ (.xlsx) â€” ì—´ ìˆœì„œ: ì¹´í…Œê³ ë¦¬, êµ¬ë¶„(ê°œì¸/ë²•ì¸), ì œëª©, URL</label><input type="file" id="bv-file" accept=".xlsx,.xls,.csv"></div>
        <div class="fg"><label>ê°€ê²©(ì›)</label><input id="bv-price" type="number" value="2000" min="0" step="100"></div>
        <button type="button" class="btn mt" onclick="batchVideoUpload()">ì—‘ì…€ì—ì„œ ì¼ê´„ ë“±ë¡</button>
        <div id="bv-progress" style="margin-top:12px"></div>
      </div>
      <button type="button" class="btn btn-sec mt" onclick="$('batch-area').classList.add('hidden')">ë‹«ê¸°</button>
    </div><div id="cf-area" class="hidden form-box"><form onsubmit="saveCont(event)"><input type="hidden" id="cf-id"><div class="fr"><div class="fg"><label>ì œëª©</label><input id="cf-title" required></div><div class="fg"><label>ì¹´í…Œê³ ë¦¬</label><select id="cf-cat"></select></div></div><div class="fr"><div class="fg"><label>ìœ í˜•</label><select id="cf-type" onchange="onCfTypeChange()"><option value="video">ğŸ¬ ì˜ìƒì½˜í…ì¸ </option><option value="brief">ğŸ“° ì´ìŠˆë¸Œë¦¬í•‘</option><option value="audio">ğŸ§ ì˜¤ë””ì˜¤</option><option value="report">ğŸ“Š íŠ¹ê¸‰ë³´ê³ ì„œ</option><option value="closing">ğŸ“‘ í´ë¡œì§•PPT</option></select></div><div class="fg"><label>ê°€ê²©(ì›)</label><input id="cf-price" type="number" required min="0" step="100" value="2000"></div></div><div id="cf-sub-wrap" class="fg hidden"><label>êµ¬ë¶„ (ê°œì¸/ë²•ì¸)</label><select id="cf-subtype"><option value="">ì—†ìŒ</option><option value="ê°œì¸">ê°œì¸</option><option value="ë²•ì¸">ë²•ì¸</option></select></div><div class="fg"><label id="cf-url-label">ì½˜í…ì¸  URL</label><input id="cf-url" type="url" required></div><div id="cf-audio-upload" class="fg hidden"><label>ì˜¤ë””ì˜¤ íŒŒì¼ ì—…ë¡œë“œ</label><div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap"><input type="file" id="cf-audio-file" accept="audio/*" onchange="uploadAudio(this)"><span id="cf-audio-progress" style="font-size:13px;color:#666"></span></div></div><div id="cf-video-wrap" class="fg hidden"><label>ì˜ìƒ URL (í´ë¡œì§•PPTìš©)</label><input id="cf-videourl" type="url" placeholder="ì˜ìƒ URL"></div><div id="cf-pptx-wrap" class="fg hidden"><label>PPTX ë‹¤ìš´ë¡œë“œ URL (í´ë¡œì§•PPTìš©)</label><input id="cf-pptxurl" type="url" placeholder="PPTX íŒŒì¼ URL"></div><div class="fg"><label>ì¸ë„¤ì¼ URL (ì„ íƒ)</label><input id="cf-thumb"></div><div class="fg"><label>ìš”ì•½</label><textarea id="cf-summary" rows="3"></textarea></div><div class="fr"><div class="fg"><label>ì •ë ¬ìˆœì„œ</label><input id="cf-sort" type="number" value="0"></div><div class="fg"><label>ë…¸ì¶œ</label><select id="cf-active"><option value="1">ë…¸ì¶œ</option><option value="0">ë¹„ë…¸ì¶œ</option></select></div></div><button type="submit" class="btn">ì €ì¥</button> <button type="button" class="btn btn-sec" onclick="document.getElementById('cf-area').classList.add('hidden')">ì·¨ì†Œ</button></form></div><div class="toolbar mt"><input id="c-search" placeholder="ì œëª©/ì¹´í…Œê³ ë¦¬/ìœ í˜• ê²€ìƒ‰..." oninput="renderConts()"> <select id="c-type-filter" onchange="renderConts()"><option value="">ì „ì²´ ìœ í˜•</option><option value="video">ì˜ìƒì½˜í…ì¸ </option><option value="brief">ì´ìŠˆë¸Œë¦¬í•‘</option><option value="audio">ì˜¤ë””ì˜¤</option><option value="report">íŠ¹ê¸‰ë³´ê³ ì„œ</option><option value="closing">í´ë¡œì§•PPT</option></select> <button class="btn-danger" onclick="delSelected()">ğŸ—‘ ì„ íƒì‚­ì œ</button></div><div class="tbl-wrap mt"><table class="tbl"><thead><tr><th style="width:36px"><input type="checkbox" id="c-all-chk" onchange="toggleAllChk(this.checked)"></th><th style="width:40px">No</th><th>ì œëª©</th><th>ì¹´í…Œê³ ë¦¬</th><th>ìœ í˜•</th><th>êµ¬ë¶„</th><th>ê°€ê²©</th><th>ì—´ëŒìˆ˜</th><th>ë“±ë¡ì¼</th><th>ë…¸ì¶œ</th><th>ê´€ë¦¬</th></tr></thead><tbody id="tb-conts"></tbody></table></div><div id="cont-pager" style="display:flex;justify-content:center;align-items:center;gap:8px;margin-top:12px"></div></div>
    <div id="p-cats" class="panel hidden"><h2>ì¹´í…Œê³ ë¦¬ ê´€ë¦¬</h2><div class="toolbar"><input id="nc-name" placeholder="ì¹´í…Œê³ ë¦¬ëª…"><button class="btn" onclick="addCat()">ì¶”ê°€</button></div><div class="tbl-wrap"><table class="tbl mt"><thead><tr><th>ì¹´í…Œê³ ë¦¬ëª…</th><th>ì •ë ¬</th><th>ìƒíƒœ</th><th>ê´€ë¦¬</th></tr></thead><tbody id="tb-cats"></tbody></table></div></div>
    <div id="p-pays" class="panel hidden"><h2>ê²°ì œ/ì¶©ì „ ê´€ë¦¬</h2><div class="tbl-wrap"><table class="tbl"><thead><tr><th>ë‚ ì§œ</th><th>íšŒì›</th><th>ê²°ì œê¸ˆì•¡</th><th>ì¶©ì „í¬ë ˆë”§</th><th>ìƒíƒœ</th></tr></thead><tbody id="tb-pays"></tbody></table></div>
      <h3 style="margin-top:24px;padding-top:16px;border-top:2px solid var(--border-lt)">ğŸ¤– PPT ìƒì„± ê²°ì œ ë‚´ì—­</h3>
      <div class="tbl-wrap mt"><table class="tbl"><thead><tr><th>ë‚ ì§œ</th><th>íšŒì›</th><th>PT ì œëª©</th><th>ê¸ˆì•¡</th><th>ê²°ì œìƒíƒœ</th></tr></thead><tbody id="tb-pays-pptgen"></tbody></table></div>
    </div>
    <div id="p-logs" class="panel hidden"><h2>ì´ìš©ë¡œê·¸ / ì •ì‚°</h2><div class="toolbar"><label>ê¸°ê°„:</label><input id="lg-from" type="date"> ~ <input id="lg-to" type="date"><button class="btn" onclick="loadLogs()">ì¡°íšŒ</button><button class="btn btn-sec" onclick="exportCSV()">CSV ë‹¤ìš´ë¡œë“œ</button></div><div id="lg-summary" class="dash-row mt"></div><div class="tbl-wrap mt"><table class="tbl"><thead><tr><th>ë‚ ì§œ</th><th>íšŒì›</th><th>ì½˜í…ì¸ ëª…ì¹­</th><th>ì½˜í…ì¸ </th><th>ì°¨ê°ì•¡</th></tr></thead><tbody id="tb-logs"></tbody></table></div>
      <h3 style="margin-top:24px;padding-top:16px;border-top:2px solid var(--border-lt)">ğŸ¤– PPT ìƒì„± ì´ìš© ë¡œê·¸</h3>
      <div id="lg-pptgen-summary" class="dash-row mt"></div>
      <div class="tbl-wrap mt"><table class="tbl"><thead><tr><th>ë‚ ì§œ</th><th>íšŒì›</th><th>ìœ í˜•</th><th>PT ì œëª©</th><th>ìƒíƒœ</th><th>ì°¨ê°ì•¡</th></tr></thead><tbody id="tb-logs-pptgen"></tbody></table></div>
    </div>
    <div id="p-props" class="panel hidden"><h2>ì œíœ´ ì œì•ˆí•¨</h2><div class="tbl-wrap"><table class="tbl"><thead><tr><th>ì ‘ìˆ˜ì¼</th><th>íšŒì›</th><th>ì œëª©</th><th>ìƒíƒœ</th><th>ê´€ë¦¬</th></tr></thead><tbody id="tb-props"></tbody></table></div></div>
    <div id="p-notices" class="panel hidden"><h2>ê³µì§€ì‚¬í•­ ê´€ë¦¬</h2><button class="btn" onclick="showNF()">ê³µì§€ ë“±ë¡</button><div id="nf-area" class="hidden form-box"><input type="hidden" id="nf-id"><div class="fg"><label>ì œëª©</label><input id="nf-title" required></div><div class="fg"><label>ë‚´ìš©</label>
      <div class="rich-toolbar" id="nf-toolbar">
        <button type="button" class="btn btn-sm" onclick="richFmt('bold','nf-body')" title="êµµê²Œ"><b>B</b></button>
        <button type="button" class="btn btn-sm" onclick="richFmt('italic','nf-body')" title="ê¸°ìš¸ì„"><i>I</i></button>
        <button type="button" class="btn btn-sm" onclick="richFmt('underline','nf-body')" title="ë°‘ì¤„"><u>U</u></button>
        <span class="tb-sep">|</span>
        <select onchange="richFmt('fontSize',this.value,'nf-body');this.selectedIndex=0" title="ê¸€ìí¬ê¸°" style="padding:4px 6px;border:1px solid var(--border);border-radius:4px;font-size:12px;font-family:var(--font)">
          <option value="">í¬ê¸°</option><option value="1">ì•„ì£¼ì‘ê²Œ</option><option value="2">ì‘ê²Œ</option><option value="3">ë³´í†µ</option><option value="4">í¬ê²Œ</option><option value="5">ì•„ì£¼í¬ê²Œ</option><option value="6">ë§¤ìš°í¬ê²Œ</option>
        </select>
        <button type="button" class="btn btn-sm" onclick="richFmt('h2','nf-body')" title="ëŒ€ì œëª©">H2</button>
        <button type="button" class="btn btn-sm" onclick="richFmt('h3','nf-body')" title="ì†Œì œëª©">H3</button>
        <span class="tb-sep">|</span>
        <button type="button" class="btn btn-sm" onclick="richFmt('color','nf-body')" title="ê¸€ììƒ‰">ğŸ¨ìƒ‰ìƒ</button><input type="color" id="nf-color" value="#2E86AB" style="width:28px;height:24px;border:none;padding:0;cursor:pointer;vertical-align:middle">
        <span class="tb-sep">|</span>
        <button type="button" class="btn btn-sm" onclick="richFmt('justifyLeft','nf-body')" title="ì™¼ìª½ì •ë ¬">â¬…</button>
        <button type="button" class="btn btn-sm" onclick="richFmt('justifyCenter','nf-body')" title="ê°€ìš´ë°ì •ë ¬">â¬›</button>
        <button type="button" class="btn btn-sm" onclick="richFmt('justifyRight','nf-body')" title="ì˜¤ë¥¸ìª½ì •ë ¬">â¡</button>
        <span class="tb-sep">|</span>
        <button type="button" class="btn btn-sm" onclick="richFmt('ul','nf-body')" title="â—ëª©ë¡">â€¢ ëª©ë¡</button>
        <button type="button" class="btn btn-sm" onclick="richFmt('ol','nf-body')" title="ìˆ«ìëª©ë¡">1. ëª©ë¡</button>
        <button type="button" class="btn btn-sm" onclick="richFmt('hr','nf-body')" title="êµ¬ë¶„ì„ ">â”€â”€ êµ¬ë¶„ì„ </button>
        <button type="button" class="btn btn-sm" onclick="richFmt('link','nf-body')" title="ë§í¬">ğŸ”—ë§í¬</button>
        <button type="button" class="btn btn-sm" onclick="richFmt('image','nf-body')" title="ì´ë¯¸ì§€">ğŸ–¼ì´ë¯¸ì§€</button>
        <span class="tb-sep">|</span>
        <button type="button" class="btn btn-sm" onclick="richFmt('undo','nf-body')" title="ë˜ëŒë¦¬ê¸°">â†©</button>
        <button type="button" class="btn btn-sm" onclick="richFmt('redo','nf-body')" title="ë‹¤ì‹œì‹¤í–‰">â†ª</button>
      </div>
      <div id="nf-body" contenteditable="true" class="rich-editor"></div>
    </div><div class="fg"><label>ë…¸ì¶œ</label><select id="nf-active"><option value="1">ë…¸ì¶œ</option><option value="0">ë¹„ë…¸ì¶œ</option></select></div><div style="display:flex;gap:8px"><button type="button" class="btn" onclick="saveNotice(event)">ì €ì¥</button> <button type="button" class="btn btn-sec" onclick="nfPreview()">ë¯¸ë¦¬ë³´ê¸°</button> <button type="button" class="btn btn-sec" onclick="document.getElementById('nf-area').classList.add('hidden')">ì·¨ì†Œ</button></div>
    <div id="nf-preview" class="form-box mt" style="display:none"><h3 style="margin-bottom:12px">ë¯¸ë¦¬ë³´ê¸°</h3><div id="nf-preview-body" style="font-size:14px;line-height:1.8"></div></div>
    </div><div class="tbl-wrap"><table class="tbl mt"><thead><tr><th style="width:50px">No.</th><th>ì œëª©</th><th>ë…¸ì¶œ</th><th>ë“±ë¡ì¼</th><th>ê´€ë¦¬</th></tr></thead><tbody id="tb-notices"></tbody></table></div></div>
    <div id="p-guide" class="panel hidden"><h2>ì´ìš© ê°€ì´ë“œ ê´€ë¦¬</h2><p style="color:#666;margin-bottom:16px">ì‚¬ìš©ì ë©”ì¸í™”ë©´ ìƒë‹¨ì˜ "ì´ìš©ê°€ì´ë“œ" ë²„íŠ¼ì„ í´ë¦­í•˜ë©´ í‘œì‹œë˜ëŠ” ë‚´ìš©ì…ë‹ˆë‹¤.</p>
    <div class="fg"><label>ì œëª©</label><input id="gd-title" value="ì´ìš© ê°€ì´ë“œ"></div>
    <div class="fg"><label>ë‚´ìš©</label>
      <div class="rich-toolbar" id="gd-toolbar">
        <button type="button" class="btn btn-sm" onclick="richFmt('bold','gd-body')" title="êµµê²Œ"><b>B</b></button>
        <button type="button" class="btn btn-sm" onclick="richFmt('italic','gd-body')" title="ê¸°ìš¸ì„"><i>I</i></button>
        <button type="button" class="btn btn-sm" onclick="richFmt('underline','gd-body')" title="ë°‘ì¤„"><u>U</u></button>
        <span class="tb-sep">|</span>
        <select onchange="richFmt('fontSize',this.value,'gd-body');this.selectedIndex=0" title="ê¸€ìí¬ê¸°" style="padding:4px 6px;border:1px solid var(--border);border-radius:4px;font-size:12px;font-family:var(--font)">
          <option value="">í¬ê¸°</option><option value="1">ì•„ì£¼ì‘ê²Œ</option><option value="2">ì‘ê²Œ</option><option value="3">ë³´í†µ</option><option value="4">í¬ê²Œ</option><option value="5">ì•„ì£¼í¬ê²Œ</option><option value="6">ë§¤ìš°í¬ê²Œ</option>
        </select>
        <button type="button" class="btn btn-sm" onclick="richFmt('h2','gd-body')" title="ëŒ€ì œëª©">H2</button>
        <button type="button" class="btn btn-sm" onclick="richFmt('h3','gd-body')" title="ì†Œì œëª©">H3</button>
        <span class="tb-sep">|</span>
        <button type="button" class="btn btn-sm" onclick="richFmt('color','gd-body')" title="ê¸€ììƒ‰">ğŸ¨ìƒ‰ìƒ</button><input type="color" id="gd-color" value="#2E86AB" style="width:28px;height:24px;border:none;padding:0;cursor:pointer;vertical-align:middle">
        <span class="tb-sep">|</span>
        <button type="button" class="btn btn-sm" onclick="richFmt('justifyLeft','gd-body')" title="ì™¼ìª½ì •ë ¬">â¬…</button>
        <button type="button" class="btn btn-sm" onclick="richFmt('justifyCenter','gd-body')" title="ê°€ìš´ë°ì •ë ¬">â¬›</button>
        <button type="button" class="btn btn-sm" onclick="richFmt('justifyRight','gd-body')" title="ì˜¤ë¥¸ìª½ì •ë ¬">â¡</button>
        <span class="tb-sep">|</span>
        <button type="button" class="btn btn-sm" onclick="richFmt('ul','gd-body')" title="â—ëª©ë¡">â€¢ ëª©ë¡</button>
        <button type="button" class="btn btn-sm" onclick="richFmt('ol','gd-body')" title="ìˆ«ìëª©ë¡">1. ëª©ë¡</button>
        <button type="button" class="btn btn-sm" onclick="richFmt('hr','gd-body')" title="êµ¬ë¶„ì„ ">â”€â”€ êµ¬ë¶„ì„ </button>
        <button type="button" class="btn btn-sm" onclick="richFmt('link','gd-body')" title="ë§í¬">ğŸ”—ë§í¬</button>
        <button type="button" class="btn btn-sm" onclick="richFmt('image','gd-body')" title="ì´ë¯¸ì§€">ğŸ–¼ì´ë¯¸ì§€</button>
        <span class="tb-sep">|</span>
        <button type="button" class="btn btn-sm" onclick="richFmt('undo','gd-body')" title="ë˜ëŒë¦¬ê¸°">â†©</button>
        <button type="button" class="btn btn-sm" onclick="richFmt('redo','gd-body')" title="ë‹¤ì‹œì‹¤í–‰">â†ª</button>
      </div>
      <div id="gd-body" contenteditable="true" class="rich-editor" style="min-height:400px"></div>
    </div>
    <div style="margin-top:12px;display:flex;gap:8px"><button type="button" class="btn" onclick="saveGuide()">ì €ì¥</button><button type="button" class="btn btn-sec" onclick="gdPreview()">ë¯¸ë¦¬ë³´ê¸°</button></div>
    <div id="gd-preview" class="form-box mt" style="display:none"><h3 style="margin-bottom:12px">ë¯¸ë¦¬ë³´ê¸°</h3><div id="gd-preview-body" style="font-size:14px;line-height:1.8"></div></div></div>
    <div id="p-terms" class="panel hidden"><h2>ì•½ê´€ ê´€ë¦¬</h2><div class="tabs"><button class="tab active" onclick="loadTermEdit('terms_of_service',this)">ì´ìš©ì•½ê´€</button><button class="tab" onclick="loadTermEdit('privacy_policy',this)">ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨</button></div><form onsubmit="saveTerm(event)"><input type="hidden" id="te-type" value="terms_of_service"><div class="fg"><textarea id="te-body" rows="15" style="font-family:monospace"></textarea></div><button type="submit" class="btn">ì €ì¥</button></form></div>
    <div id="p-chargeopt" class="panel hidden"><h2>ì¶©ì „ ê¸ˆì•¡ ì„¤ì •</h2><div class="toolbar"><input id="co-paid" type="number" placeholder="ê²°ì œê¸ˆì•¡(ì›)" style="min-width:0;flex:1"><input id="co-credit" type="number" placeholder="ì¶©ì „í¬ë ˆë”§(ì›)" style="min-width:0;flex:1"><input id="co-label" placeholder="í‘œì‹œí…ìŠ¤íŠ¸" style="min-width:0;flex:1"><button class="btn" onclick="addChargeOpt()">ì¶”ê°€</button></div><div class="tbl-wrap"><table class="tbl mt"><thead><tr><th>ê²°ì œê¸ˆì•¡</th><th>ì¶©ì „í¬ë ˆë”§</th><th>í‘œì‹œ</th><th>ì •ë ¬</th><th>ìƒíƒœ</th><th>ê´€ë¦¬</th></tr></thead><tbody id="tb-copts"></tbody></table></div></div>
    <div id="p-thumbs" class="panel hidden"><h2>ìœ í˜•ë³„ ì¸ë„¤ì¼ ì„¤ì •</h2><p style="color:#666;margin-bottom:16px">ìœ í˜•ë³„ ê¸°ë³¸ ì¸ë„¤ì¼ ì´ë¯¸ì§€ë¥¼ ì„¤ì •í•˜ë©´ í•´ë‹¹ ìœ í˜•ì˜ ì½˜í…ì¸ ì— ìë™ ì ìš©ë©ë‹ˆë‹¤. ì´ë¯¸ì§€ ìœ„ì— ì½˜í…ì¸  ì œëª©ì´ í•©ì„±ë©ë‹ˆë‹¤.</p><div class="form-box" id="thumb-form"><div class="fr"><div class="fg"><label>ì ìš© ë²”ìœ„</label><select id="th-scope" onchange="toggleThDate()"><option value="all">ì „ì²´ ì ìš©</option><option value="after">íŠ¹ì •ì¼ ì´í›„ ì ìš©</option></select></div><div class="fg" id="th-date-wrap" style="display:none"><label>ì ìš© ì‹œì‘ì¼</label><input id="th-date" type="date"></div></div><div id="th-types"></div><button class="btn mt" onclick="saveThumbs()">ì €ì¥</button></div></div>
    <div id="p-referral-set" class="panel hidden"><h2>ì¶”ì²œ ì„¤ì •</h2><p style="color:#666;margin-bottom:16px">ì¶”ì²œ ë²„íŠ¼ì´ í‘œì‹œë  íšŒì›ìœ í˜•ì„ ì„ íƒí•˜ê³ , ì¶”ì²œ ë³´ìƒ í¬ì¸íŠ¸ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.</p><div class="form-box"><h3>ì¶”ì²œ ê°€ëŠ¥ íšŒì›ìœ í˜•</h3><div style="display:flex;flex-wrap:wrap;gap:16px;margin:12px 0"><label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:14px"><input type="checkbox" id="ref-role-jarvia" value="jarvia_member"> JARVIAë©¤ë²„ì‹­</label><label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:14px"><input type="checkbox" id="ref-role-inner" value="inner_circle"> ì´ë„ˆì„œí´</label><label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:14px"><input type="checkbox" id="ref-role-user" value="user"> ì¼ë°˜íšŒì›</label><label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:14px"><input type="checkbox" id="ref-role-free" value="free_user"> ë¬´ë£ŒíšŒì›</label><label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:14px"><input type="checkbox" id="ref-role-branch" value="branch_manager"> ì§€ì‚¬ì¥</label></div><h3 class="mt">ì¶”ì²œ ë³´ìƒ í¬ì¸íŠ¸</h3><div class="fr" style="margin:12px 0"><div class="fg"><label>ë³´ìƒ í¬ì¸íŠ¸(P)</label><input id="ref-reward" type="number" value="50000" min="0" step="1000"></div></div><button class="btn mt" onclick="saveRefSet()">ì €ì¥</button></div></div>
    <div id="p-referral-status" class="panel hidden"><h2>ì¶”ì²œ í˜„í™©</h2>
      <div class="toolbar"><label>ê¸°ê°„:</label><input id="rs-from" type="date"> ~ <input id="rs-to" type="date"><button class="btn" onclick="loadRefStatus()">ì¡°íšŒ</button><button class="btn btn-sec" onclick="setRefPeriod('today')">ì˜¤ëŠ˜</button><button class="btn btn-sec" onclick="setRefPeriod('week')">ì´ë²ˆì£¼</button><button class="btn btn-sec" onclick="setRefPeriod('month')">ì´ë²ˆë‹¬</button><button class="btn btn-sec" onclick="setRefPeriod('all')">ì „ì²´</button></div>
      <div id="rs-summary" class="dash-row mt"></div>
      <h3 class="mt">ì¶”ì²œìë³„ í˜„í™©</h3>
      <div class="tbl-wrap"><table class="tbl"><thead><tr><th>ì¶”ì²œì</th><th>ì•„ì´ë””</th><th>ì¶”ì²œ ì¸ì›</th><th>ëˆ„ì  í¬ì¸íŠ¸</th><th>í˜„ì¬ í¬ì¸íŠ¸</th></tr></thead><tbody id="tb-ref-summary"></tbody></table></div>
      <h3 class="mt">ì¶”ì²œ ìƒì„¸ ë‚´ì—­</h3>
      <div class="tbl-wrap"><table class="tbl"><thead><tr><th>ì¼ì‹œ</th><th>ì¶”ì²œì</th><th>í”¼ì¶”ì²œì</th><th>ë³€ê²½ìœ í˜•</th><th>ì§€ê¸‰ í¬ì¸íŠ¸</th></tr></thead><tbody id="tb-ref-detail"></tbody></table></div>
    </div>
    <div id="p-upcoming" class="panel hidden"><h2>ê²Œì‹œì˜ˆì • ì½˜í…ì¸  ê´€ë¦¬</h2><button class="btn" onclick="showUF()">ê²Œì‹œì˜ˆì • ë“±ë¡</button><div id="uf-area" class="hidden form-box"><input type="hidden" id="uf-id"><div class="fr"><div class="fg"><label>ê²Œì‹œì˜ˆì •ì¼</label><input id="uf-date" type="date" required></div><div class="fg"><label>ì¹´í…Œê³ ë¦¬</label><select id="uf-cat"><option value="í´ë¡œì§•PPT">í´ë¡œì§•PPT</option><option value="íŠ¹ê¸‰ë³´ê³ ì„œ">íŠ¹ê¸‰ë³´ê³ ì„œ</option><option value="ì´ìŠˆë¸Œë¦¬í•‘">ì´ìŠˆë¸Œë¦¬í•‘</option><option value="ì˜ìƒì½˜í…ì¸ ">ì˜ìƒì½˜í…ì¸ </option><option value="ì˜¤ë””ì˜¤">ì˜¤ë””ì˜¤</option></select></div></div><div class="fr"><div class="fg"><label>êµ¬ë¶„</label><select id="uf-field"><option value="ê°œì¸">ê°œì¸</option><option value="ë²•ì¸">ë²•ì¸</option></select></div><div class="fg"><label>ì œëª©</label><input id="uf-title" required></div></div><div class="fr"><div class="fg"><label>ì˜ìƒ</label><select id="uf-video"><option value="">-</option><option value="O">O</option></select></div><div class="fg"><label>ì˜¤ë””ì˜¤</label><select id="uf-audio"><option value="">-</option><option value="O">O</option></select></div><div class="fg"><label>HTML</label><select id="uf-html"><option value="">-</option><option value="O">O</option></select></div><div class="fg"><label>PDF</label><select id="uf-pdf"><option value="">-</option><option value="O">O</option></select></div><div class="fg"><label>PPT</label><select id="uf-ppt"><option value="">-</option><option value="O">O</option></select></div></div><button class="btn" onclick="saveUpcoming()">ì €ì¥</button> <button type="button" class="btn btn-sec" onclick="document.getElementById('uf-area').classList.add('hidden')">ì·¨ì†Œ</button></div><div style="overflow-x:auto;-webkit-overflow-scrolling:touch"><table class="tbl mt" style="min-width:700px;table-layout:fixed;border-collapse:collapse"><thead><tr><th style="text-align:center;width:100px">ê²Œì‹œì˜ˆì •ì¼</th><th style="text-align:center;width:90px">ì¹´í…Œê³ ë¦¬</th><th style="text-align:center;width:50px">êµ¬ë¶„</th><th style="text-align:left">ì œëª©</th><th style="text-align:center;width:40px">ì˜ìƒ</th><th style="text-align:center;width:40px">ì˜¤ë””ì˜¤</th><th style="text-align:center;width:40px">HTML</th><th style="text-align:center;width:40px">PDF</th><th style="text-align:center;width:40px">PPT</th><th style="text-align:center;width:130px">ê´€ë¦¬</th></tr></thead><tbody id="tb-upcoming"></tbody></table></div></div>
    <div id="p-popups" class="panel hidden"><h2>íŒì—… ê´€ë¦¬</h2><p style="color:#666;margin-bottom:16px">íšŒì› ìœ í˜•ë³„ ë¡œê·¸ì¸ íŒì—…ì„ ê´€ë¦¬í•©ë‹ˆë‹¤. íšŒì›ì´ ë¡œê·¸ì¸í•˜ë©´ í•´ë‹¹ ìœ í˜• íŒì—… + ê³µí†µ íŒì—…ì´ í‘œì‹œë©ë‹ˆë‹¤.</p>
      <div class="tabs" id="popup-tabs">
        <button class="tab active" onclick="switchPopupTab('common',this)">ê³µí†µ(ì „ì²´)</button>
        <button class="tab" onclick="switchPopupTab('free_user',this)">ë¬´ë£ŒíšŒì›</button>
        <button class="tab" onclick="switchPopupTab('user',this)">ì¼ë°˜íšŒì›</button>
        <button class="tab" onclick="switchPopupTab('jarvia_member',this)">JARVIAë©¤ë²„ì‹­</button>
        <button class="tab" onclick="switchPopupTab('inner_circle',this)">ì´ë„ˆì„œí´</button>
        <button class="tab" onclick="switchPopupTab('branch_manager',this)">ì§€ì‚¬ì¥</button>
      </div>
      <div id="popup-edit-area" class="form-box">
        <div class="fr"><div class="fg"><label>ì œëª©</label><input id="pp-title"></div><div class="fg"><label>ë…¸ì¶œ</label><select id="pp-active"><option value="1">ë…¸ì¶œ</option><option value="0">ë¹„ë…¸ì¶œ</option></select></div></div>
        <div class="fr"><div class="fg"><label>ê²Œì‹œì‹œì‘ì¼</label><input id="pp-start" type="date"></div><div class="fg"><label>ê²Œì‹œë§Œë£Œì¼</label><input id="pp-end" type="date"></div></div>
        <div class="fg"><label>ë‚´ìš© (ë¦¬ì¹˜ ì—ë””í„°)</label>
          <div class="rich-toolbar">
            <button type="button" class="btn btn-sm" onclick="richFmt('bold','pp-body')" title="êµµê²Œ"><b>B</b></button>
            <button type="button" class="btn btn-sm" onclick="richFmt('italic','pp-body')" title="ê¸°ìš¸ì„"><i>I</i></button>
            <button type="button" class="btn btn-sm" onclick="richFmt('underline','pp-body')" title="ë°‘ì¤„"><u>U</u></button>
            <span class="tb-sep">|</span>
            <select onchange="richFmt('fontSize',this.value,'pp-body');this.selectedIndex=0" style="padding:4px 6px;border:1px solid var(--border);border-radius:4px;font-size:12px;font-family:var(--font)">
              <option value="">í¬ê¸°</option><option value="1">ì•„ì£¼ì‘ê²Œ</option><option value="2">ì‘ê²Œ</option><option value="3">ë³´í†µ</option><option value="4">í¬ê²Œ</option><option value="5">ì•„ì£¼í¬ê²Œ</option><option value="6">ë§¤ìš°í¬ê²Œ</option>
            </select>
            <button type="button" class="btn btn-sm" onclick="richFmt('h2','pp-body')" title="ëŒ€ì œëª©">H2</button>
            <button type="button" class="btn btn-sm" onclick="richFmt('h3','pp-body')" title="ì†Œì œëª©">H3</button>
            <span class="tb-sep">|</span>
            <button type="button" class="btn btn-sm" onclick="richFmt('color','pp-body')" title="ê¸€ììƒ‰">ğŸ¨ìƒ‰ìƒ</button><input type="color" id="pp-color" value="#2E86AB" style="width:28px;height:24px;border:none;padding:0;cursor:pointer;vertical-align:middle">
            <span class="tb-sep">|</span>
            <button type="button" class="btn btn-sm" onclick="richFmt('justifyLeft','pp-body')" title="ì™¼ìª½ì •ë ¬">â¬…</button>
            <button type="button" class="btn btn-sm" onclick="richFmt('justifyCenter','pp-body')" title="ê°€ìš´ë°ì •ë ¬">â¬›</button>
            <button type="button" class="btn btn-sm" onclick="richFmt('justifyRight','pp-body')" title="ì˜¤ë¥¸ìª½ì •ë ¬">â¡</button>
            <span class="tb-sep">|</span>
            <button type="button" class="btn btn-sm" onclick="richFmt('ul','pp-body')" title="â—ëª©ë¡">â€¢ ëª©ë¡</button>
            <button type="button" class="btn btn-sm" onclick="richFmt('ol','pp-body')" title="ìˆ«ìëª©ë¡">1. ëª©ë¡</button>
            <button type="button" class="btn btn-sm" onclick="richFmt('hr','pp-body')" title="êµ¬ë¶„ì„ ">â”€â”€ êµ¬ë¶„ì„ </button>
            <button type="button" class="btn btn-sm" onclick="richFmt('link','pp-body')" title="ë§í¬">ğŸ”—ë§í¬</button>
            <button type="button" class="btn btn-sm" onclick="richFmt('image','pp-body')" title="ì´ë¯¸ì§€">ğŸ–¼ì´ë¯¸ì§€</button>
            <span class="tb-sep">|</span>
            <button type="button" class="btn btn-sm" onclick="richFmt('undo','pp-body')" title="ë˜ëŒë¦¬ê¸°">â†©</button>
            <button type="button" class="btn btn-sm" onclick="richFmt('redo','pp-body')" title="ë‹¤ì‹œì‹¤í–‰">â†ª</button>
          </div>
          <div id="pp-body" contenteditable="true" class="rich-editor"></div>
        </div>
        <div style="display:flex;gap:8px"><button class="btn" onclick="savePopup()">ì €ì¥</button><button class="btn btn-sec" onclick="ppPreview()">ë¯¸ë¦¬ë³´ê¸°</button><button class="btn btn-danger" onclick="deletePopup()">ì‚­ì œ</button></div>
        <div id="pp-preview" class="form-box mt" style="display:none"><h3 style="margin-bottom:12px">ë¯¸ë¦¬ë³´ê¸°</h3><div id="pp-preview-body" style="font-size:14px;line-height:1.8"></div></div>
        <div id="pp-status" style="margin-top:12px;font-size:13px;color:var(--text-lt)"></div>
      </div>
    </div>
    <!-- â•â•â• PPT ìƒì„± ê´€ë¦¬ â•â•â• -->
    <div id="p-pptgen" class="panel hidden"><h2>ğŸ¤– PPT ìƒì„± ê´€ë¦¬</h2>
      <div class="dash-row" id="pptgen-dash">
        <div class="dash-c"><span>ì˜¤ëŠ˜ ìƒì„±</span><strong id="pg-today">0</strong><em>ê±´</em></div>
        <div class="dash-c"><span>ì˜¤ëŠ˜ ë§¤ì¶œ</span><strong id="pg-rev">0</strong><em>ì›</em></div>
        <div class="dash-c"><span>ì „ì²´ ì™„ë£Œ</span><strong id="pg-total">0</strong><em>ê±´</em></div>
        <div class="dash-c"><span>ì‹¤íŒ¨/í™˜ë¶ˆ</span><strong id="pg-fail">0</strong><em>ê±´</em></div>
      </div>
      <div class="toolbar">
        <label>ê¸°ê°„:</label><input id="pg-from" type="date"> ~ <input id="pg-to" type="date">
        <select id="pg-status-filter"><option value="">ì „ì²´ ìƒíƒœ</option><option value="completed">ì™„ë£Œ</option><option value="processing">ìƒì„±ì¤‘</option><option value="pending">ëŒ€ê¸°</option><option value="failed">ì‹¤íŒ¨</option></select>
        <button class="btn" onclick="loadPptGenAdmin()">ì¡°íšŒ</button>
        <button class="btn btn-sec" onclick="exportPptGenCSV()">CSV ë‹¤ìš´ë¡œë“œ</button>
      </div>
      <div class="tbl-wrap mt"><table class="tbl"><thead><tr>
        <th>ìƒì„±ì¼ì‹œ</th><th>íšŒì›</th><th>ìœ í˜•</th><th>PT ì œëª©</th><th>ìƒíƒœ</th><th>ë¹„ìš©</th><th>ê²°ì œìƒíƒœ</th><th>ì”ì—¬ì¼</th></tr></thead>
        <tbody id="tb-pptgen"></tbody>
      </table></div>
    </div>
  </main>
</div>
<div id="mdl-member" class="modal hidden"><div class="mdl-bg" onclick="closeM('mdl-member')"></div><div class="mdl-box mdl-lg"><button class="mdl-x" onclick="closeM('mdl-member')">Ã—</button><div id="member-inner"></div></div></div>
<div id="mdl-prop" class="modal hidden"><div class="mdl-bg" onclick="closeM('mdl-prop')"></div><div class="mdl-box mdl-lg"><button class="mdl-x" onclick="closeM('mdl-prop')">Ã—</button><div id="prop-inner"></div></div></div>
<div id="toast" class="toast hidden"></div>

<script type="module">
import{initializeApp}from'https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js';
import{getAuth,onAuthStateChanged,signOut,createUserWithEmailAndPassword}from'https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js';
import{getFirestore,collection,doc,getDoc,getDocs,setDoc,updateDoc,deleteDoc,query,where,orderBy,limit,runTransaction,serverTimestamp,increment,Timestamp,deleteField}from'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js';
import{getStorage,ref as stRef,uploadBytesResumable,getDownloadURL}from'https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js';

const FC={apiKey:"AIzaSyCf7CsUTgfIWY-RW_mvTJOhczDtk1xM9sA",authDomain:"kfpc-company-support-project.firebaseapp.com",projectId:"kfpc-company-support-project",storageBucket:"kfpc-company-support-project.firebasestorage.app",messagingSenderId:"1012609333373",appId:"1:1012609333373:web:7b6c207c81ff10d156d914",measurementId:"G-CMW6QQ470G"};
const app=initializeApp(FC);
const auth=getAuth(app);
const db=getFirestore(app,'javia-db');
const storage=getStorage(app);

const $=id=>document.getElementById(id);
const gid=()=>Date.now().toString(36)+Math.random().toString(36).substr(2,9);
const fmt=n=>(n||0).toLocaleString('ko-KR');
const fdate=t=>{if(!t)return'-';const d=t.toDate?t.toDate():new Date(t);return d.toLocaleDateString('ko-KR');};
const fdatetime=t=>{if(!t)return'-';const d=t.toDate?t.toDate():new Date(t);return d.toLocaleDateString('ko-KR')+' '+d.toLocaleTimeString('ko-KR',{hour:'2-digit',minute:'2-digit'});};
const esc=s=>{if(!s)return'';const d=document.createElement('div');d.textContent=s;return d.innerHTML;};
let _tt;function toast(m,t=''){const e=$('toast');e.textContent=m;e.className='toast'+(t?' toast-'+t:'');e.classList.remove('hidden');clearTimeout(_tt);_tt=setTimeout(()=>e.classList.add('hidden'),3000);}
function openM(id){$(id).classList.remove('hidden');}
function closeM(id){$(id).classList.add('hidden');}
function typeBadge(t,action){const l={video:'ì˜ìƒì½˜í…ì¸ ',brief:'ì´ìŠˆë¸Œë¦¬í•‘',audio:'ì˜¤ë””ì˜¤',report:'íŠ¹ê¸‰ë³´ê³ ì„œ',closing:'í´ë¡œì§•PPT',doc:'ë¬¸ì„œ',ppt:'PPT',html:'HTML'};if(t==='closing'&&action==='ppt_download')return`<span class="badge badge-closing-ppt">í´ë¡œì§•PPT</span>`;if(t==='closing'&&action==='view')return`<span class="badge badge-closing-pdf">í´ë¡œì§•PDF</span>`;return`<span class="badge badge-${t}">${l[t]||t}</span>`;}
function expiryStatus(m){
  if(m.expiresAt==='unlimited')return{text:'ë¬´ì œí•œ',cls:'st-ok',short:'ë¬´ì œí•œ'};
  if(!m.expiresAt)return{text:'ë¯¸ì„¤ì •',cls:'st-warn',short:'ë¯¸ì„¤ì •'};
  const exp=m.expiresAt.toDate?m.expiresAt.toDate():new Date(m.expiresAt);
  const startSrc=m.startsAt||m.createdAt;
  const start=startSrc?(startSrc.toDate?startSrc.toDate():new Date(startSrc)):null;
  const now=new Date(),diff=Math.ceil((exp-now)/(1000*60*60*24));
  const startStr=start?fdate(startSrc):'';const endStr=fdate(m.expiresAt);
  if(diff<0)return{text:startStr+'~'+endStr+' (ë§Œë£Œ)',cls:'st-expired',short:'ë§Œë£Œ'};
  if(diff<=7)return{text:startStr+'~'+endStr+' ('+diff+'ì¼ ë‚¨ìŒ)',cls:'st-warn',short:diff+'ì¼'};
  return{text:startStr+'~'+endStr+' ('+diff+'ì¼ ë‚¨ìŒ)',cls:'st-ok',short:diff+'ì¼'};
}
function showAddUser(){document.getElementById('add-user-form').classList.toggle('hidden');if(!$('nu-start').value)initNuDates();}

let admUser=null,admData=null;

onAuthStateChanged(auth,async u=>{
  if(!u||!u.email||!u.email.endsWith('@javia-admin.internal')){window.location.href='index.html';return;}
  admUser=u;
  const lid=u.email.replace('@javia-admin.internal','');
  const snap=await getDocs(query(collection(db,'admins'),where('loginId','==',lid),limit(1)));
  if(snap.empty){window.location.href='index.html';return;}
  admData=snap.docs[0].data();
  $('adm-name').textContent=(admData.name||admData.loginId)+' ('+({superadmin:'ì´ê´„',admin:'ê´€ë¦¬ì'}[admData.role]||admData.role)+')';
  if($('mob-adm-name'))$('mob-adm-name').textContent=$('adm-name').textContent;
  loadDash();
});

async function admLogout(){await signOut(auth);window.location.href='index.html';}

function goPanel(el){
  document.querySelectorAll('.sn').forEach(a=>a.classList.remove('active'));el.classList.add('active');
  document.querySelectorAll('.panel').forEach(p=>p.classList.add('hidden'));$(el.dataset.p).classList.remove('hidden');
  document.querySelector('.sidebar').classList.remove('show');
  const ld={'p-dash':loadDash,'p-members':loadMembers,'p-admins':loadAdmins,'p-contents':loadConts,'p-cats':loadCats,'p-pays':loadPaysAll,'p-logs':loadLogsAll,'p-props':loadProps,'p-notices':loadNoticesAdm,'p-guide':loadGuide,'p-terms':()=>loadTermEdit('terms_of_service'),'p-chargeopt':loadChargeOpts,'p-thumbs':loadThumbs,'p-referral-set':loadRefSet,'p-referral-status':loadRefStatus,'p-upcoming':loadUpcomingAdm,'p-popups':loadPopups,'p-pptgen':loadPptGenAdmin};
  if(ld[el.dataset.p])ld[el.dataset.p]();
}

// â•â•â• DASHBOARD â•â•â•
async function loadDash(){
  const today=new Date();today.setHours(0,0,0,0);const tTs=Timestamp.fromDate(today);
  const su=await getDocs(query(collection(db,'users'),where('createdAt','>=',tTs)));$('d-signup').textContent=su.size;
  const vw=await getDocs(query(collection(db,'view_logs'),where('createdAt','>=',tTs)));$('d-views').textContent=vw.size;
  const ch=await getDocs(query(collection(db,'payments'),where('status','==','paid'),where('createdAt','>=',tTs)));
  let rev=0;ch.forEach(d=>rev+=(d.data().paidAmount||0));$('d-rev').textContent=fmt(rev);
  let totalUsers=0;
  try{
    const tt1=await getDocs(query(collection(db,'users'),where('role','==','free_user')));
    const tt2=await getDocs(query(collection(db,'users'),where('role','==','user')));
    totalUsers=tt1.size+tt2.size;
  }catch(e){
    const allU=await getDocs(collection(db,'users'));
    totalUsers=allU.docs.filter(d=>{const r=d.data().role;return r==='free_user'||r==='user'||r==='jarvia_member'||r==='inner_circle'||r==='branch_manager';}).length;
  }
  $('d-total').textContent=totalUsers;
  // PPT ìƒì„± í†µê³„
  try{
    const pgSnap=await getDocs(query(collection(db,'pptgen_jobs'),where('createdAt','>=',tTs)));
    let pgCount=0,pgRev=0;
    pgSnap.forEach(d=>{const j=d.data();pgCount++;if(j.paymentStatus==='confirmed')pgRev+=(j.genPrice||0);});
    $('d-pptgen').textContent=pgCount;$('d-pptrev').textContent=fmt(pgRev);
  }catch(e){$('d-pptgen').textContent='-';$('d-pptrev').textContent='-';}
}

// â•â•â• MEMBERS â•â•â•
async function loadMembers(){
  const s=($('m-search')?.value||'').toLowerCase();
  let list=[];
  try{
    const snap1=await getDocs(query(collection(db,'users'),where('role','==','free_user'),orderBy('createdAt','desc')));
    const snap2=await getDocs(query(collection(db,'users'),where('role','==','user'),orderBy('createdAt','desc')));
    list=[...snap1.docs,...snap2.docs].map(d=>({id:d.id,...d.data()}));
  }catch(e){
    console.warn('ë³µí•© ì¸ë±ìŠ¤ ì—†ìŒ, ì „ì²´ ì¡°íšŒ fallback:',e.message);
    const snapAll=await getDocs(collection(db,'users'));
    list=snapAll.docs.map(d=>({id:d.id,...d.data()})).filter(m=>m.role==='free_user'||m.role==='user'||m.role==='jarvia_member'||m.role==='inner_circle'||m.role==='branch_manager');
    list.sort((a,b)=>{const at=a.createdAt?.toDate?a.createdAt.toDate():new Date(0);const bt=b.createdAt?.toDate?b.createdAt.toDate():new Date(0);return bt-at;});
  }
  if(s)list=list.filter(m=>(m.name||'').toLowerCase().includes(s)||(m.phone||'').includes(s)||(m.email||'').toLowerCase().includes(s)||(m.loginId||'').toLowerCase().includes(s));
  const roleLabel=r=>({free_user:'ë¬´ë£ŒíšŒì›',user:'ì¼ë°˜íšŒì›',jarvia_member:'JARVIAë©¤ë²„ì‹­',inner_circle:'ì´ë„ˆì„œí´',branch_manager:'ì§€ì‚¬ì¥'}[r]||r);
  const roleClass=r=>({free_user:'st-active',user:'st-ok',jarvia_member:'st-jarvia',inner_circle:'st-inner',branch_manager:'st-inner'}[r]||'');
  const regFeeIcon=m=>m.role==='jarvia_member'?(m.regFeePaid?' âœ…ì…ê¸ˆí™•ì¸':' âŒë¯¸í™•ì¸'):'';
  const refName=rc=>{if(!rc)return'-';const f=list.find(x=>x.referralCode===rc);return f?esc(f.name):rc;};
  if(!window._mPage)window._mPage=1;const perPage=10;const totalPages=Math.max(1,Math.ceil(list.length/perPage));if(window._mPage>totalPages)window._mPage=totalPages;const startIdx=(window._mPage-1)*perPage;const pageList=list.slice(startIdx,startIdx+perPage);
  $('tb-members').innerHTML=pageList.length?pageList.map((m,i)=>{const no=startIdx+i+1;const es=expiryStatus(m);return`<tr><td><input type="checkbox" class="m-chk" value="${m.id}"></td><td style="text-align:center">${no}</td><td>${fdate(m.createdAt)}</td><td><span class="${roleClass(m.role)}">${roleLabel(m.role)}</span>${regFeeIcon(m)}</td><td>${esc(m.name)}</td><td>${esc(m.loginId||'')}</td><td>${esc(m.company||'')}</td><td>${esc(m.phone||'')}</td><td><span class="${es.cls}">${es.text}</span></td><td>${fmt(m.balance)}ì›</td><td>${fmt(m.point||0)}P</td><td>${m.role==='jarvia_member'?fmt(m.monthlyFee||50000)+'ì›':'-'}</td><td><span class="st-${m.status}">${m.status==='active'?'ì •ìƒ':'ì •ì§€'}</span></td><td>${refName(m.referredBy)}</td><td><button class="btn btn-sm" onclick="showMember('${m.id}')">ìˆ˜ì •</button></td></tr>`;}).join(''):'<tr><td colspan="15" class="tc">ë“±ë¡ëœ íšŒì›ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
  let pgHtml='';if(totalPages>1){pgHtml+='<button class="btn btn-sm btn-sec" '+(window._mPage<=1?'disabled':'')+' onclick="window._mPage=1;loadMembers()">Â«</button>';pgHtml+='<button class="btn btn-sm btn-sec" '+(window._mPage<=1?'disabled':'')+' onclick="window._mPage--;loadMembers()">â€¹</button>';for(let p=1;p<=totalPages;p++){if(p===1||p===totalPages||Math.abs(p-window._mPage)<=2){pgHtml+='<button class="btn btn-sm'+(p===window._mPage?' btn-primary':' btn-sec')+'" onclick="window._mPage='+p+';loadMembers()">'+p+'</button>';}else if(Math.abs(p-window._mPage)===3){pgHtml+='<span style="padding:0 4px">â€¦</span>';}}pgHtml+='<button class="btn btn-sm btn-sec" '+(window._mPage>=totalPages?'disabled':'')+' onclick="window._mPage++;loadMembers()">â€º</button>';pgHtml+='<button class="btn btn-sm btn-sec" '+(window._mPage>=totalPages?'disabled':'')+' onclick="window._mPage='+totalPages+';loadMembers()">Â»</button>';pgHtml+='<span style="margin-left:12px;font-size:13px;color:#888">ì´ '+list.length+'ëª…</span>';}else if(list.length){pgHtml='<span style="font-size:13px;color:#888">ì´ '+list.length+'ëª…</span>';}
  $('m-pagination').innerHTML=pgHtml;
  if($('m-chk-all'))$('m-chk-all').checked=false;
}

async function showMember(uid){
  const d=await getDoc(doc(db,'users',uid));if(!d.exists()){toast('íšŒì› ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.','error');return;}const m=d.data();
  const es=expiryStatus(m);
  let vlDocs=[],txDocs=[],pgDocs=[];
  try{const vlSnap=await getDocs(query(collection(db,'view_logs'),where('userId','==',uid),orderBy('createdAt','desc'),limit(20)));vlDocs=vlSnap.docs;}catch(e){try{const all=await getDocs(query(collection(db,'view_logs'),where('userId','==',uid)));vlDocs=all.docs.sort((a,b)=>(b.data().createdAt?.toMillis?.()??0)-(a.data().createdAt?.toMillis?.()??0)).slice(0,20);}catch(e2){}}
  try{const txSnap=await getDocs(query(collection(db,'transactions'),where('userId','==',uid),orderBy('createdAt','desc'),limit(20)));txDocs=txSnap.docs;}catch(e){try{const all=await getDocs(query(collection(db,'transactions'),where('userId','==',uid)));txDocs=all.docs.sort((a,b)=>(b.data().createdAt?.toMillis?.()??0)-(a.data().createdAt?.toMillis?.()??0)).slice(0,20);}catch(e2){}}
  try{const pgSnap=await getDocs(query(collection(db,'pptgen_jobs'),where('userId','==',uid),orderBy('createdAt','desc'),limit(20)));pgDocs=pgSnap.docs;}catch(e){try{const all=await getDocs(query(collection(db,'pptgen_jobs'),where('userId','==',uid)));pgDocs=all.docs.sort((a,b)=>(b.data().createdAt?.toMillis?.()??0)-(a.data().createdAt?.toMillis?.()??0)).slice(0,20);}catch(e2){}}
  // ì¶”ì²œì¸ ì´ë¦„ ì¡°íšŒ
  let refByName='-';
  if(m.referredBy){try{const rs=await getDocs(query(collection(db,'users'),where('referralCode','==',m.referredBy),limit(1)));if(!rs.empty)refByName=rs.docs[0].data().name||m.referredBy;}catch(e){refByName=m.referredBy;}}
  // PPT ìƒì„± ë‚´ì—­ HTML ë¯¸ë¦¬ ìƒì„±
  const _pgStMap={pending:'â³ ëŒ€ê¸°',processing:'ğŸ”„ ìƒì„±ì¤‘',completed:'âœ… ì™„ë£Œ',failed:'âŒ ì‹¤íŒ¨'};
  const _pgPayMap={hold:'ğŸŸ¡ ëŒ€ê¸°',confirmed:'ğŸŸ¢ í™•ì •',refunded:'ğŸ”µ í™˜ë¶ˆ'};
  const pgHtml=pgDocs.map(d=>{const j=d.data();const tp=j.clientType==='personal'?'ğŸ‘¤ ê°œì¸':'ğŸ¢ ê¸°ì—…';const title=j.formData?.ptTitle||'-';const cost=j.genPrice>0?fmt(j.genPrice)+'ì›':'ë¬´ë£Œ';return'<tr><td>'+fdatetime(j.createdAt)+'</td><td>'+tp+'</td><td class="ov">'+esc(title)+'</td><td>'+(_pgStMap[j.status]||j.status)+'</td><td style="text-align:right">'+cost+'</td><td>'+(_pgPayMap[j.paymentStatus]||j.paymentStatus||'-')+'</td></tr>';}).join('')||'<tr><td colspan="6" class="tc">ë‚´ì—­ ì—†ìŒ</td></tr>';
  $('member-inner').innerHTML=`<h2>${esc(m.name)} íšŒì› ìˆ˜ì •</h2>
    <div class="info-grid"><div><label>ì•„ì´ë””:</label>${esc(m.loginId)}</div><div><label>ì†Œì†:</label>${esc(m.company||'')}</div><div><label>ì§í•¨:</label>${esc(m.title||'')}</div><div><label>ì—°ë½ì²˜:</label>${esc(m.phone||'')}</div><div><label>ì´ë©”ì¼:</label>${esc(m.email||'')}</div><div><label>ìƒíƒœ:</label><span class="st-${m.status}">${m.status==='active'?'ì •ìƒ':'ì •ì§€'}</span></div><div><label>ì”ì•¡:</label><strong style="color:var(--accent);font-size:18px">${fmt(m.balance)}ì›</strong></div><div><label>í¬ì¸íŠ¸:</label><strong style="color:var(--success);font-size:18px">${fmt(m.point||0)}P</strong></div><div><label>ì´ìš©ë§Œë£Œ:</label><span class="${es.cls}" style="font-weight:600">${es.text}</span></div><div><label>ê°€ì…ì¼:</label>${fdate(m.createdAt)}</div><div><label>ë§ˆì§€ë§‰ ë¡œê·¸ì¸:</label>${fdatetime(m.lastLoginAt)}</div><div><label>ì¶”ì²œì½”ë“œ:</label>${esc(m.referralCode||'-')}</div><div><label>ì¶”ì²œì¸:</label><strong style="color:var(--primary)">${esc(refByName)}</strong></div><div><label>ì¶”ì²œí¬ì¸íŠ¸:</label><strong style="color:var(--success)">${fmt(m.referralPoints||0)}P</strong></div></div>
    <div style="margin:16px 0;display:flex;gap:8px"><button class="btn btn-sm" onclick="toggleStatus('${uid}','${m.status}')">${m.status==='active'?'ì •ì§€í•˜ê¸°':'í•´ì œí•˜ê¸°'}</button></div>
    <h3>íšŒì› ì •ë³´ ìˆ˜ì •</h3>
    <div class="fr" style="margin:12px 0"><div class="fg"><label>ì´ë¦„</label><input id="ed-name-${uid}" value="${esc(m.name||'')}"></div><div class="fg"><label>íšŒì›ìœ í˜•</label><select id="ed-role-${uid}" onchange="(function(sel){var jArea=document.getElementById('jarvia-area-${uid}');if(jArea)jArea.style.display=sel.value==='jarvia_member'?'':'none';var expArea=document.getElementById('exp-section-${uid}');if(expArea)expArea.style.display=(sel.value==='user'||sel.value==='jarvia_member'||sel.value==='inner_circle'||sel.value==='branch_manager')?'none':'';})(this)"><option value="user" ${m.role==='user'?'selected':''}>ì¼ë°˜íšŒì› (ìœ ë£Œ)</option><option value="free_user" ${m.role==='free_user'?'selected':''}>ë¬´ë£ŒíšŒì›</option><option value="jarvia_member" ${m.role==='jarvia_member'?'selected':''}>JARVIAë©¤ë²„ì‹­</option><option value="inner_circle" ${m.role==='inner_circle'?'selected':''}>ì´ë„ˆì„œí´ë©¤ë²„ì‹­</option><option value="branch_manager" ${m.role==='branch_manager'?'selected':''}>ì§€ì‚¬ì¥</option></select></div><button class="btn btn-sm" style="align-self:end" onclick="updateMemberInfo('${uid}')">ì €ì¥</button></div>
    <div id="jarvia-area-${uid}" style="${m.role==='jarvia_member'?'':'display:none'}"><h3>JARVIAë©¤ë²„ì‹­ ì„¤ì •</h3>
    <div class="fr" style="margin:12px 0"><div class="fg"><label>ë“±ë¡ë¹„ ì…ê¸ˆí™•ì¸</label><select id="ed-regfee-${uid}"><option value="unpaid" ${m.regFeePaid!==true?'selected':''}>ë¯¸í™•ì¸</option><option value="paid" ${m.regFeePaid===true?'selected':''}>ì…ê¸ˆí™•ì¸</option></select></div><div class="fg"><label>ì›” ì •ê¸°ê²°ì œ ê¸ˆì•¡(ì›)</label><input id="ed-monthly-${uid}" type="number" value="${m.monthlyFee||50000}" min="0" step="1000"></div><button class="btn btn-sm" style="align-self:end" onclick="updateJarviaMember('${uid}')">ì €ì¥</button></div></div>
    <div class="fr" style="margin:0 0 16px"><div class="fg"><label>ìƒˆ ë¹„ë°€ë²ˆí˜¸</label><input id="ed-pw-${uid}" type="password" placeholder="ë³€ê²½ ì‹œì—ë§Œ ì…ë ¥"></div><button class="btn btn-sm btn-warning" style="align-self:end" onclick="changeMemberPw('${uid}','${esc(m.email)}')">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</button></div>
    <div id="exp-section-${uid}" style="${m.role==='user'||m.role==='jarvia_member'||m.role==='inner_circle'||m.role==='branch_manager'?'display:none':''}"><h3>ì´ìš©ê¸°ê°„ ì„¤ì •</h3>
    <div class="fr" style="margin:12px 0 16px"><div class="fg"><label>ì‹œì‘ì¼</label><input id="expstart-${uid}" type="date" value="${(function(){var s=m.startsAt||m.createdAt;if(!s)return '';var d=s.toDate?s.toDate():new Date(s);return d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0')})()}"></div><div class="fg"><label>ë§Œë£Œì¼</label><input id="expdate-${uid}" type="date" value="${(function(){if(!m.expiresAt||m.expiresAt==='unlimited')return '';var d=m.expiresAt.toDate?m.expiresAt.toDate():new Date(m.expiresAt);return d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0')})()}"></div><label style="align-self:end;font-size:13px;cursor:pointer;margin-bottom:8px"><input type="checkbox" id="exp-unlim-${uid}" ${m.expiresAt==='unlimited'?'checked':''} onchange="var ds=$('expstart-'+this.dataset.uid);var de=$('expdate-'+this.dataset.uid);if(this.checked){de.disabled=true;de.value='';}else{de.disabled=false;}" data-uid="${uid}"> ë¬´ì œí•œ</label><button class="btn btn-sm btn-success" style="align-self:end" onclick="setExpPeriod('${uid}')">ì ìš©</button></div></div>
    <h3>ì”ì•¡ ì¡°ì •</h3><div class="fr" style="margin-bottom:16px"><div class="fg"><label>ê¸ˆì•¡(+/-)</label><input id="adj-amt-${uid}" type="number" placeholder="5000"></div><div class="fg"><label>ì‚¬ìœ (í•„ìˆ˜)</label><input id="adj-memo-${uid}" placeholder="ì‚¬ìœ  ì…ë ¥"></div><button class="btn btn-sm" style="align-self:end" onclick="doAdjust('${uid}')">ì¡°ì •</button></div>
    <h3>í¬ì¸íŠ¸ ì¡°ì •</h3><div class="fr" style="margin-bottom:16px"><div class="fg"><label>í¬ì¸íŠ¸(+/-)</label><input id="adj-pt-${uid}" type="number" placeholder="5000"></div><div class="fg"><label>ì‚¬ìœ (í•„ìˆ˜)</label><input id="adj-ptmemo-${uid}" placeholder="ì‚¬ìœ  ì…ë ¥"></div><button class="btn btn-sm btn-success" style="align-self:end" onclick="doAdjustPoint('${uid}')">ì¡°ì •</button></div>
    <h3>ì´ìš© ë‚´ì—­(ìµœê·¼ 20ê±´)</h3><div class="tbl-wrap"><table class="tbl"><thead><tr><th>ë‚ ì§œ</th><th>ì½˜í…ì¸ ID</th><th>ì°¨ê°ì•¡</th></tr></thead><tbody>${vlDocs.map(d=>{const l=d.data();return`<tr><td>${fdatetime(l.createdAt)}</td><td class="ov">${l.contentId}</td><td>${l.price>0?fmt(l.price)+'ì›':'ë¬´ë£Œ'}</td></tr>`;}).join('')||'<tr><td colspan="3" class="tc">ë‚´ì—­ ì—†ìŒ</td></tr>'}</tbody></table></div>
    <h3 class="mt">íŠ¸ëœì­ì…˜(ìµœê·¼ 20ê±´)</h3><div class="tbl-wrap"><table class="tbl"><thead><tr><th>ë‚ ì§œ</th><th>ìœ í˜•</th><th>ê¸ˆì•¡</th><th>ì”ì•¡</th><th>í¬ì¸íŠ¸</th><th>ë©”ëª¨</th></tr></thead><tbody>${txDocs.map(d=>{const t=d.data();return`<tr><td>${fdatetime(t.createdAt)}</td><td>${t.type}</td><td style="color:${t.amount>=0?'var(--success)':'var(--danger)'}"> ${t.amount>=0?'+':''}${fmt(t.amount)}ì›</td><td>${t.balanceAfter!=null?fmt(t.balanceAfter)+'ì›':'-'}</td><td>${t.pointAfter!=null?fmt(t.pointAfter)+'P':'-'}</td><td>${esc(t.memo||'')}</td></tr>`;}).join('')||'<tr><td colspan="6" class="tc">ë‚´ì—­ ì—†ìŒ</td></tr>'}</tbody></table></div>
    <h3 class="mt">ğŸ¤– PPT ìƒì„± ë‚´ì—­(ìµœê·¼ 20ê±´)</h3><div class="tbl-wrap"><table class="tbl"><thead><tr><th>ë‚ ì§œ</th><th>ìœ í˜•</th><th>PT ì œëª©</th><th>ìƒíƒœ</th><th>ë¹„ìš©</th><th>ê²°ì œìƒíƒœ</th></tr></thead><tbody>${pgHtml}</tbody></table></div>`;
  openM('mdl-member');
}

async function toggleStatus(uid,cur){const ns=cur==='active'?'suspended':'active';if(!confirm('íšŒì›ì„ '+(ns==='suspended'?'ì •ì§€':'í•´ì œ')+'í•˜ì‹œê² ìŠµë‹ˆê¹Œ?'))return;await updateDoc(doc(db,'users',uid),{status:ns,updatedAt:serverTimestamp()});toast('ìƒíƒœ ë³€ê²½ ì™„ë£Œ','success');closeM('mdl-member');loadMembers();}

async function updateMemberInfo(uid){
  const name=$('ed-name-'+uid).value.trim();
  const role=$('ed-role-'+uid).value;
  if(!name)return toast('ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.','error');
  if(!['user','free_user','jarvia_member','inner_circle','branch_manager'].includes(role))return toast('ì˜¬ë°”ë¥¸ íšŒì›ìœ í˜•ì„ ì„ íƒí•˜ì„¸ìš”.','error');
  try{
    // ê¸°ì¡´ ì—­í•  í™•ì¸ (jarvia_member ë³€ê²½ ê°ì§€ìš©)
    const prevDoc=await getDoc(doc(db,'users',uid));const prevRole=prevDoc.exists()?prevDoc.data().role:'';
    const updateData={name,role,updatedAt:serverTimestamp()};
    if(role==='user'||role==='inner_circle'||role==='free_user'||role==='branch_manager'){updateData.expiresAt=deleteField();}
    await updateDoc(doc(db,'users',uid),updateData);
    // JARVIAë©¤ë²„ì‹­ìœ¼ë¡œ ìƒˆë¡œ ë³€ê²½ëœ ê²½ìš° â†’ ì¶”ì²œì¸ì—ê²Œ í¬ì¸íŠ¸ ì§€ê¸‰
    if(role!==prevRole&&role==='jarvia_member'&&prevRole!=='jarvia_member'){
      let rwdPts=50000;
      try{const rs=await getDoc(doc(db,'settings','referral_settings'));if(rs.exists()&&rs.data().rewardPoints)rwdPts=rs.data().rewardPoints;}catch(e){}
      const userData=prevDoc.data();
      if(userData.referredBy){
        try{
          const refSnap=await getDocs(query(collection(db,'users'),where('referralCode','==',userData.referredBy),limit(1)));
          if(!refSnap.empty){
            const refDoc=refSnap.docs[0];const refUid=refDoc.id;
            const txId='ref_'+Date.now().toString(36)+Math.random().toString(36).substr(2,5);
            await runTransaction(db,async tx=>{
              const rd=(await tx.get(doc(db,'users',refUid))).data();
              const newPt=(rd.point||0)+rwdPts;
              tx.update(doc(db,'users',refUid),{referralPoints:increment(rwdPts),point:increment(rwdPts),updatedAt:serverTimestamp()});
              tx.set(doc(db,'transactions',txId),{txId,userId:refUid,type:'referral_reward',amount:rwdPts,pointAfter:newPt,memo:name+'ë‹˜ '+({free_user:'ë¬´ë£ŒíšŒì›',user:'ì¼ë°˜íšŒì›',jarvia_member:'JARVIAë©¤ë²„ì‹­',inner_circle:'ì´ë„ˆì„œí´',branch_manager:'ì§€ì‚¬ì¥'}[role]||role)+' ê°€ì… ì¶”ì²œë³´ìƒ',createdAt:serverTimestamp()});
            });
            toast('ì¶”ì²œì¸ '+refDoc.data().name+'ì—ê²Œ '+fmt(rwdPts)+'P ì§€ê¸‰ ì™„ë£Œ','success');
          }
        }catch(re){console.error('ì¶”ì²œ í¬ì¸íŠ¸ ì§€ê¸‰ ì˜¤ë¥˜:',re);toast('ì¶”ì²œ í¬ì¸íŠ¸ ì§€ê¸‰ ì˜¤ë¥˜: '+re.message,'error');}
      }
    }
    toast('íšŒì› ì •ë³´ ìˆ˜ì • ì™„ë£Œ','success');closeM('mdl-member');loadMembers();
  }catch(e){toast('ìˆ˜ì • ì‹¤íŒ¨: '+e.message,'error');}
}

async function changeMemberPw(uid,email){
  const pw=$('ed-pw-'+uid).value;
  if(!pw)return toast('ìƒˆ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.','error');
  if(pw.length<6)return toast('ë¹„ë°€ë²ˆí˜¸ëŠ” 6ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.','error');
  if(!confirm('ë¹„ë°€ë²ˆí˜¸ë¥¼ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?'))return;
  try{
    const {getAuth:gA,signInWithEmailAndPassword:sI,updatePassword:uP}=await import('https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js');
    // Admin SDK ì—†ì´ í´ë¼ì´ì–¸íŠ¸ì—ì„œ ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ì€ ì œí•œì ì´ë¯€ë¡œ ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì • ì´ë©”ì¼ ë°œì†¡
    const {sendPasswordResetEmail:sR}=await import('https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js');
    await sR(auth,email);
    toast('ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì • ì´ë©”ì¼ì´ '+email+'ë¡œ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.','success');
  }catch(e){toast('ë°œì†¡ ì‹¤íŒ¨: '+e.message,'error');}
}

function toggleAllMembers(){const ck=$('m-chk-all').checked;document.querySelectorAll('.m-chk').forEach(c=>c.checked=ck);}
async function deleteSelectedMembers(){
  const checks=[...document.querySelectorAll('.m-chk:checked')];
  if(!checks.length)return toast('ì‚­ì œí•  íšŒì›ì„ ì„ íƒí•˜ì„¸ìš”.','error');
  if(!confirm(checks.length+'ëª…ì˜ íšŒì›ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(Firebase Auth ê³„ì •ì€ ìœ ì§€ë˜ë©°, Firestore ë°ì´í„°ë§Œ ì‚­ì œë©ë‹ˆë‹¤.)'))return;
  let cnt=0;
  for(const ck of checks){
    try{await deleteDoc(doc(db,'users',ck.value));cnt++;}catch(e){console.error('ì‚­ì œ ì‹¤íŒ¨:',ck.value,e);}
  }
  toast(cnt+'ëª… ì‚­ì œ ì™„ë£Œ','success');loadMembers();
}

async function doAdjust(uid){
  const amt=parseInt($('adj-amt-'+uid).value),memo=$('adj-memo-'+uid).value.trim();
  if(isNaN(amt)||amt===0)return toast('ê¸ˆì•¡ì„ ì…ë ¥í•˜ì„¸ìš”.','error');if(!memo)return toast('ì‚¬ìœ ë¥¼ ì…ë ¥í•˜ì„¸ìš”.','error');
  try{const uRef=doc(db,'users',uid);
    await runTransaction(db,async tx=>{const ud=(await tx.get(uRef)).data();const nb=ud.balance+amt;if(nb<0)throw new Error('ì”ì•¡ì´ ìŒìˆ˜ê°€ ë©ë‹ˆë‹¤.');tx.update(uRef,{balance:nb,updatedAt:serverTimestamp()});const tid=gid();tx.set(doc(db,'transactions',tid),{txId:tid,userId:uid,type:'admin_adjust',amount:amt,balanceAfter:nb,refType:'admin',refId:admUser.uid,memo,createdAt:serverTimestamp()});});
    toast('ì”ì•¡ ì¡°ì • ì™„ë£Œ','success');closeM('mdl-member');loadMembers();
  }catch(e){toast('ì¡°ì • ì‹¤íŒ¨: '+e.message,'error');}
}
async function doAdjustPoint(uid){
  const amt=parseInt($('adj-pt-'+uid).value),memo=$('adj-ptmemo-'+uid).value.trim();
  if(isNaN(amt)||amt===0)return toast('í¬ì¸íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.','error');if(!memo)return toast('ì‚¬ìœ ë¥¼ ì…ë ¥í•˜ì„¸ìš”.','error');
  try{const uRef=doc(db,'users',uid);
    await runTransaction(db,async tx=>{const ud=(await tx.get(uRef)).data();const np=(ud.point||0)+amt;if(np<0)throw new Error('í¬ì¸íŠ¸ê°€ ìŒìˆ˜ê°€ ë©ë‹ˆë‹¤.');tx.update(uRef,{point:np,updatedAt:serverTimestamp()});const tid=gid();tx.set(doc(db,'transactions',tid),{txId:tid,userId:uid,type:'admin_point_adjust',amount:amt,pointAfter:np,refType:'admin',refId:admUser.uid,memo,createdAt:serverTimestamp()});});
    toast('í¬ì¸íŠ¸ ì¡°ì • ì™„ë£Œ','success');closeM('mdl-member');loadMembers();
  }catch(e){toast('ì¡°ì • ì‹¤íŒ¨: '+e.message,'error');}
}

// â•â•â• FREE USER CREATION & PERIOD MANAGEMENT â•â•â•
function nuEmailSel(){const v=$('nu-email-sel').value;$('nu-email-domain').value=v;$('nu-email-domain').readOnly=!!v;if(!v)$('nu-email-domain').focus();}
function getNuEmail(){const id=($('nu-email-id')?.value||'').trim(),dm=($('nu-email-domain')?.value||'').trim();return id&&dm?id+'@'+dm:'';}
function getNuPhone(){const p1=($('nu-ph1')?.value||'010'),p2=($('nu-ph2')?.value||'').trim(),p3=($('nu-ph3')?.value||'').trim();return p2&&p3?p1+'-'+p2+'-'+p3:p2||p3?p1+'-'+p2+'-'+p3:'';}
function nuUnlimitedChk(){const ck=$('nu-unlimited').checked;$('nu-start').disabled=ck;$('nu-end').disabled=ck;if(ck){$('nu-start').value='';$('nu-end').value='';}}
function initNuDates(){const today=new Date().toISOString().split('T')[0];$('nu-start').value=today;const d30=new Date(Date.now()+30*24*60*60*1000).toISOString().split('T')[0];$('nu-end').value=d30;}

async function createFreeUser(){
  const name=$('nu-name').value.trim(),loginId=$('nu-loginid').value.trim(),pw=$('nu-pw').value;
  const email=getNuEmail(),phone=getNuPhone();
  const company=$('nu-company')?.value.trim()||'',title=$('nu-title')?.value.trim()||'';
  const isUnlimited=$('nu-unlimited').checked;
  const startVal=$('nu-start').value,endVal=$('nu-end').value;
  if(!name||!loginId||!pw||!email)return toast('í•„ìˆ˜í•­ëª©(ì´ë¦„,ì•„ì´ë””,ë¹„ë°€ë²ˆí˜¸,ì´ë©”ì¼)ì„ ì…ë ¥í•˜ì„¸ìš”.','error');
  if(pw.length<6)return toast('ë¹„ë°€ë²ˆí˜¸ 6ì ì´ìƒ','error');
  if(!isUnlimited&&(!startVal||!endVal))return toast('ì´ìš©ê¸°ê°„(ì‹œì‘ì¼/ì¢…ë£Œì¼)ì„ ì„ íƒí•˜ì„¸ìš”.','error');
  if(!isUnlimited&&startVal>endVal)return toast('ì¢…ë£Œì¼ì´ ì‹œì‘ì¼ë³´ë‹¤ ì•ì„¤ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.','error');
  const idChk=await getDocs(query(collection(db,'users'),where('loginId','==',loginId),limit(1)));
  if(!idChk.empty)return toast('ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì•„ì´ë””','error');
  try{
    const secondApp=initializeApp(FC,'tempUser'+Date.now());
    const secondAuth=getAuth(secondApp);
    const cred=await createUserWithEmailAndPassword(secondAuth,email,pw);
    const uid=cred.user.uid;
    await signOut(secondAuth);
    let startsAt=null,expiresAt='unlimited';
    if(!isUnlimited){
      const sd=new Date(startVal);sd.setHours(0,0,0,0);
      const ed=new Date(endVal);ed.setHours(23,59,59,999);
      startsAt=Timestamp.fromDate(sd);expiresAt=Timestamp.fromDate(ed);
    }
    await setDoc(doc(db,'users',uid),{
      userId:uid,name,company,title,phone,email,address:'',loginId,
      role:'free_user',status:'active',balance:0,startsAt,expiresAt,
      createdBy:admUser.uid,lastLoginAt:null,
      createdAt:serverTimestamp(),updatedAt:serverTimestamp()
    });
    const periodTxt=isUnlimited?'ë¬´ì œí•œ':startVal+'~'+endVal;
    toast('ë¬´ë£Œì‚¬ìš©ì ìƒì„± ì™„ë£Œ (ì•„ì´ë””: '+loginId+', '+periodTxt+')','success');
    document.getElementById('add-user-form').classList.add('hidden');
    ['nu-name','nu-loginid','nu-pw','nu-email-id','nu-email-domain','nu-company','nu-title','nu-ph2','nu-ph3'].forEach(id=>{const el=$(id);if(el){el.value='';el.readOnly=false;}});
    $('nu-email-sel').value='';$('nu-unlimited').checked=false;nuUnlimitedChk();initNuDates();
    loadMembers();
  }catch(e){
    if(e.code==='auth/email-already-in-use')toast('ì´ë¯¸ Authì— ì¡´ì¬í•˜ëŠ” ì´ë©”ì¼','error');
    else toast('ìƒì„± ì‹¤íŒ¨: '+e.message,'error');
  }
}

async function setExpPeriod(uid){
  const isUnlim=$('exp-unlim-'+uid).checked;
  const startVal=$('expstart-'+uid).value;
  const endVal=$('expdate-'+uid).value;
  if(!isUnlim&&!endVal)return toast('ë§Œë£Œì¼ì„ ì„ íƒí•˜ì„¸ìš”','error');
  const updateData={updatedAt:serverTimestamp()};
  if(startVal){const sd=new Date(startVal);sd.setHours(0,0,0,0);updateData.startsAt=Timestamp.fromDate(sd);}
  if(isUnlim){updateData.expiresAt='unlimited';}
  else{const ed=new Date(endVal);ed.setHours(23,59,59,999);updateData.expiresAt=Timestamp.fromDate(ed);}
  await updateDoc(doc(db,'users',uid),updateData);
  toast('ì´ìš©ê¸°ê°„ ë³€ê²½ ì™„ë£Œ','success');closeM('mdl-member');loadMembers();
}

// â•â•â• ADMINS â•â•â•
async function loadAdmins(){
  const snap=await getDocs(query(collection(db,'admins'),orderBy('createdAt','desc')));
  $('tb-admins').innerHTML=snap.docs.map(d=>{const a=d.data();const isSA=a.role==='superadmin';return`<tr><td>${esc(a.loginId)}</td><td>${esc(a.name||'')}</td><td>${a.role==='superadmin'?'ì´ê´„ê´€ë¦¬ì':'ê´€ë¦¬ì'}</td><td>${fdatetime(a.lastLoginAt)}</td><td><span class="st-${a.status}">${a.status==='active'?'ì •ìƒ':'ì •ì§€'}</span></td><td>${!isSA&&admData?.role==='superadmin'?`<button class="btn btn-sm btn-danger" onclick="delAdmin('${d.id}')">ì‚­ì œ</button>`:'-'}</td></tr>`;}).join('');
  $('btn-add-adm').style.display=admData?.role==='superadmin'?'':'none';
}

async function createAdmin(){
  const lid=$('na-id').value.trim(),name=$('na-name').value.trim(),pw=$('na-pw').value;
  if(!lid||!name||!pw)return toast('ëª¨ë“  í•­ëª©ì„ ì…ë ¥í•˜ì„¸ìš”.','error');
  if(pw.length<6)return toast('ë¹„ë°€ë²ˆí˜¸ 6ì ì´ìƒ','error');
  const ex=await getDocs(query(collection(db,'admins'),where('loginId','==',lid),limit(1)));
  if(!ex.empty)return toast('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì•„ì´ë””','error');
  try{
    const secondApp=initializeApp(FC,'tempAdmin'+Date.now());
    const secondAuth=getAuth(secondApp);
    const email=lid+'@javia-admin.internal';
    await createUserWithEmailAndPassword(secondAuth,email,pw);
    await signOut(secondAuth);
    const id=gid();
    await setDoc(doc(db,'admins',id),{adminId:id,loginId:lid,name,role:'admin',status:'active',createdBy:admUser.uid,lastLoginAt:null,createdAt:serverTimestamp()});
    toast('ê´€ë¦¬ì ì¶”ê°€ ì™„ë£Œ (ì•„ì´ë””: '+lid+')','success');
    $('add-adm-form').classList.add('hidden');$('na-id').value='';$('na-name').value='';$('na-pw').value='';loadAdmins();
  }catch(e){
    if(e.code==='auth/email-already-in-use')toast('ì´ë¯¸ Authì— ì¡´ì¬í•˜ëŠ” ê³„ì •ì…ë‹ˆë‹¤.','error');
    else toast('ìƒì„± ì‹¤íŒ¨: '+e.message,'error');
  }
}

async function delAdmin(docId){if(!confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?'))return;await deleteDoc(doc(db,'admins',docId));toast('ì‚­ì œ ì™„ë£Œ','success');loadAdmins();}

// â•â•â• CONTENTS â•â•â•
let _allConts=[],_contCatMap={},_contPage=1;const CONT_PER=10;
async function loadConts(){
  const catSnap=await getDocs(query(collection(db,'categories'),orderBy('sortOrder')));const cats=catSnap.docs.map(d=>d.data());_contCatMap={};cats.forEach(c=>_contCatMap[c.categoryId]=c.name);
  $('cf-cat').innerHTML=cats.map(c=>`<option value="${c.categoryId}">${esc(c.name)}</option>`).join('');
  if($('ba-cat'))$('ba-cat').innerHTML=$('cf-cat').innerHTML;
  const cSnap=await getDocs(query(collection(db,'contents'),orderBy('createdAt','desc')));
  _allConts=cSnap.docs.map(d=>d.data());renderConts();
}
function renderConts(){
  const s=($('c-search').value||'').toLowerCase();const tf=$('c-type-filter').value;
  const typeNames={video:'ì˜ìƒì½˜í…ì¸ ',brief:'ì´ìŠˆë¸Œë¦¬í•‘',audio:'ì˜¤ë””ì˜¤',report:'íŠ¹ê¸‰ë³´ê³ ì„œ',closing:'í´ë¡œì§•PPT'};
  let list=_allConts;
  if(tf)list=list.filter(c=>c.type===tf);
  if(s)list=list.filter(c=>(c.title||'').toLowerCase().includes(s)||(_contCatMap[c.categoryId]||'').toLowerCase().includes(s)||(typeNames[c.type]||'').includes(s));
  const total=list.length,pages=Math.max(1,Math.ceil(total/CONT_PER));
  if(_contPage>pages)_contPage=pages;
  const start=(_contPage-1)*CONT_PER,paged=list.slice(start,start+CONT_PER);
  $('tb-conts').innerHTML=paged.length?paged.map((c,i)=>`<tr><td><input type="checkbox" class="c-chk" value="${c.contentId}"></td><td>${start+i+1}</td><td class="ov">${esc(c.title)}</td><td>${esc(_contCatMap[c.categoryId]||'')}</td><td>${typeBadge(c.type)}</td><td>${c.subType||'-'}</td><td>${fmt(c.price)}ì›</td><td>${c.viewCount||0}</td><td>${fdate(c.createdAt)}</td><td>${c.isActive?'<span class="st-active">ë…¸ì¶œ</span>':'<span class="st-suspended">ë¹„ë…¸ì¶œ</span>'}</td><td><button class="btn btn-sm" onclick="editCont('${c.contentId}')">ìˆ˜ì •</button> <button class="btn-danger" onclick="delCont('${c.contentId}')">ì‚­ì œ</button></td></tr>`).join(''):'<tr><td colspan="11" class="tc">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
  if($('c-all-chk'))$('c-all-chk').checked=false;
  let pg=`<span style="font-size:13px;color:#666">ì´ ${total}ê±´</span> `;
  if(pages>1){pg+=`<button class="btn btn-sm" onclick="contPg(1)" ${_contPage===1?'disabled':''}>Â«</button>`;pg+=`<button class="btn btn-sm" onclick="contPg(${_contPage-1})" ${_contPage===1?'disabled':''}>â€¹</button>`;const st=Math.max(1,_contPage-5),en=Math.min(pages,_contPage+4);for(let i=st;i<=en;i++)pg+=`<button class="btn btn-sm" onclick="contPg(${i})" style="${i===_contPage?'background:var(--accent);color:#fff;font-weight:700':''}">${i}</button>`;pg+=`<button class="btn btn-sm" onclick="contPg(${_contPage+1})" ${_contPage===pages?'disabled':''}>â€º</button>`;pg+=`<button class="btn btn-sm" onclick="contPg(${pages})" ${_contPage===pages?'disabled':''}>Â»</button>`;}
  $('cont-pager').innerHTML=pg;
}
function contPg(p){_contPage=p;renderConts();}
function toggleAllChk(v){document.querySelectorAll('.c-chk').forEach(cb=>cb.checked=v);}
async function delSelected(){const ids=[...document.querySelectorAll('.c-chk:checked')].map(cb=>cb.value);if(!ids.length)return toast('ì„ íƒëœ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.','error');if(!confirm(`${ids.length}ê°œ ì½˜í…ì¸ ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`))return;for(const id of ids){await deleteDoc(doc(db,'contents',id));}toast(`${ids.length}ê°œ ì‚­ì œ ì™„ë£Œ`,'success');loadConts();}
function showCF(){$('batch-area').classList.add('hidden');$('bulk-price-area').classList.add('hidden');$('cf-area').classList.remove('hidden');$('cf-id').value='';document.querySelector('#cf-area form').reset();$('cf-price').value='2000';onCfTypeChange();}
function onCfTypeChange(){const t=$('cf-type').value;const labels={video:'ì˜ìƒ URL',brief:'HTML URL (GitHub)',audio:'ì˜¤ë””ì˜¤ íŒŒì¼ URL',report:'HTML URL (GitHub)',closing:'PDF URL'};$('cf-url-label').textContent=labels[t]||'ì½˜í…ì¸  URL';$('cf-sub-wrap').classList.remove('hidden');$('cf-video-wrap').classList.toggle('hidden',t!=='closing');$('cf-pptx-wrap').classList.toggle('hidden',t!=='closing'&&t!=='report');$('cf-audio-upload').classList.toggle('hidden',t!=='audio');if(t==='audio'){$('cf-url').removeAttribute('required');}else{$('cf-url').setAttribute('required','');}document.querySelector('#cf-pptx-wrap label').textContent=t==='report'?'PPTX ë‹¤ìš´ë¡œë“œ URL (íŠ¹ê¸‰ë³´ê³ ì„œìš©)':'PPTX ë‹¤ìš´ë¡œë“œ URL (í´ë¡œì§•PPTìš©)';}
async function uploadAudio(input){
  const file=input.files[0];if(!file)return;
  if(!file.type.startsWith('audio/')){toast('ì˜¤ë””ì˜¤ íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.','error');input.value='';return;}
  if(file.size>50*1024*1024){toast('íŒŒì¼ í¬ê¸°ëŠ” 50MB ì´í•˜ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.','error');input.value='';return;}
  const prog=$('cf-audio-progress');prog.textContent='ì—…ë¡œë“œ ì¤‘... 0%';
  const ext=file.name.split('.').pop()||'mp3';
  const path='audio/'+Date.now()+'_'+file.name.replace(/[^a-zA-Z0-9ê°€-í£._-]/g,'');
  const sRef=stRef(storage,path);
  const task=uploadBytesResumable(sRef,file,{contentType:file.type});
  task.on('state_changed',function(snap){
    const pct=Math.round(snap.bytesTransferred/snap.totalBytes*100);
    prog.textContent='ì—…ë¡œë“œ ì¤‘... '+pct+'%';
  },function(err){
    prog.textContent='ì—…ë¡œë“œ ì‹¤íŒ¨: '+err.message;toast('ì—…ë¡œë“œ ì‹¤íŒ¨: '+err.message,'error');
  },async function(){
    const url=await getDownloadURL(task.snapshot.ref);
    $('cf-url').value=url;
    prog.textContent='âœ… ì—…ë¡œë“œ ì™„ë£Œ';prog.style.color='var(--success)';
    toast('ì˜¤ë””ì˜¤ íŒŒì¼ ì—…ë¡œë“œ ì™„ë£Œ','success');
  });
}
async function editCont(cid){const d=await getDoc(doc(db,'contents',cid));if(!d.exists())return;const c=d.data();$('cf-id').value=cid;$('cf-title').value=c.title;$('cf-cat').value=c.categoryId;$('cf-type').value=c.type;$('cf-price').value=c.price;$('cf-url').value=c.url;$('cf-thumb').value=c.thumbnailUrl||'';$('cf-summary').value=c.summary||'';$('cf-sort').value=c.sortOrder||0;$('cf-active').value=c.isActive?'1':'0';$('cf-subtype').value=c.subType||'';$('cf-videourl').value=c.videoUrl||'';$('cf-pptxurl').value=c.pptxUrl||'';onCfTypeChange();$('cf-area').classList.remove('hidden');}
async function delCont(cid){if(!confirm('ì´ ì½˜í…ì¸ ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?'))return;await deleteDoc(doc(db,'contents',cid));toast('ì½˜í…ì¸  ì‚­ì œ ì™„ë£Œ','success');loadConts();}
function toFileUrl(u){if(!u)return u;const m=u.match(/^https:\/\/github\.com\/([^/]+)\/([^/]+)\/blob\/main\/(.+)$/);if(!m)return u;return u.toLowerCase().endsWith('.html')?`https://${m[1]}.github.io/${m[2]}/${m[3]}`:`https://raw.githubusercontent.com/${m[1]}/${m[2]}/main/${m[3]}`;}
async function saveCont(e){
  e.preventDefault();const cid=$('cf-id').value||gid();const tp=$('cf-type').value;
  const data={contentId:cid,title:$('cf-title').value.trim(),categoryId:$('cf-cat').value,type:tp,price:parseInt($('cf-price').value)||0,url:toFileUrl($('cf-url').value.trim()),thumbnailUrl:toFileUrl($('cf-thumb').value.trim())||null,summary:$('cf-summary').value.trim(),sortOrder:parseInt($('cf-sort').value)||0,isActive:$('cf-active').value==='1',updatedAt:serverTimestamp()};
  data.subType=$('cf-subtype').value||null;
  if(tp==='closing'){data.videoUrl=$('cf-videourl').value.trim()||null;data.pptxUrl=toFileUrl($('cf-pptxurl').value.trim())||null;}
  if(tp==='report'){data.pptxUrl=toFileUrl($('cf-pptxurl').value.trim())||null;}
  if(!$('cf-id').value){data.viewCount=0;data.createdAt=serverTimestamp();}
  await setDoc(doc(db,'contents',cid),data,{merge:true});toast('ì½˜í…ì¸  ì €ì¥ ì™„ë£Œ','success');$('cf-area').classList.add('hidden');loadConts();
}

// â•â•â• GITHUB SYNC â•â•â•
const GH_REPO='kfpc0808/membership';
const GH_BASE='innercircle';
const FOLDER_TYPE_MAP={'issue_briefing':'brief','special_report':'report','closing_ppt':'closing'};
async function syncGitHub(){
  if(!confirm('GitHub ì €ì¥ì†Œì—ì„œ ì‹ ê·œ íŒŒì¼ì„ ë™ê¸°í™”í•©ë‹ˆë‹¤.\nì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?'))return;
  const ss=$('sync-status');ss.style.display='block';ss.textContent='GitHub íŒŒì¼ ëª©ë¡ì„ ê°€ì ¸ì˜¤ëŠ” ì¤‘...';
  try{
    const res=await fetch(`https://api.github.com/repos/${GH_REPO}/git/trees/main?recursive=1`);
    if(!res.ok)throw new Error('GitHub API ì˜¤ë¥˜: '+res.status);
    const data=await res.json();
    const files=data.tree.filter(f=>f.type==='blob'&&f.path.startsWith(GH_BASE+'/')&&!f.path.endsWith('/index.html'));
    ss.textContent=`ì´ ${files.length}ê°œ íŒŒì¼ ë°œê²¬. ê¸°ì¡´ ì½˜í…ì¸ ì™€ ë¹„êµ ì¤‘...`;
    const cSnap=await getDocs(collection(db,'contents'));
    const existUrls=new Set(cSnap.docs.map(d=>{const u=d.data().url||'';return u;}));
    const existPptx=new Set(cSnap.docs.map(d=>{const u=d.data().pptxUrl||'';return u;}).filter(u=>u));
    let added=0,skipped=0;
    const pdfMap={};
    const reportPdfMap={};
    const reportPptxMap={};
    files.forEach(f=>{
      const ext=f.path.split('.').pop().toLowerCase();
      const parts=f.path.replace(GH_BASE+'/','').split('/');
      const folder=parts[0];
      if(ext==='pptx'&&folder==='closing_ppt'){const key=f.path.replace(/\.[^.]+$/,'');pdfMap[key]=f.path;}
      if(folder==='special_report'&&parts.length>=3&&(parts[1]==='ê°œì¸'||parts[1]==='ë²•ì¸')){
        const baseName=parts[parts.length-1].replace(/\.[^.]+$/,'');
        if(ext==='pdf')reportPdfMap[baseName]={path:f.path,subType:parts[1]};
        if(ext==='pptx')reportPptxMap[baseName]={path:f.path,subType:parts[1]};
      }
    });
    for(const f of files){
      const ext=f.path.split('.').pop().toLowerCase();
      const parts=f.path.replace(GH_BASE+'/','').split('/');
      const folder=parts[0];
      if(ext==='pptx'){skipped++;continue;}
      if(folder==='special_report'&&parts.length>=3&&(parts[1]==='ê°œì¸'||parts[1]==='ë²•ì¸')&&ext==='pdf'){skipped++;continue;}
      const rawUrl=ext==='html'?`https://kfpc0808.github.io/${GH_REPO.split('/')[1]}/${f.path}`:`https://raw.githubusercontent.com/${GH_REPO}/main/${f.path}`;
      if(existUrls.has(rawUrl)){skipped++;continue;}
      const type=FOLDER_TYPE_MAP[folder];
      if(!type){skipped++;continue;}
      let subType=null;
      let fileName=parts[parts.length-1];
      if(folder==='closing_ppt'&&parts.length>=3){subType=parts[1];}
      if(folder==='special_report'&&parts.length>=3&&(parts[1]==='ê°œì¸'||parts[1]==='ë²•ì¸')){subType=parts[1];}
      const title=fileName.replace(/\.[^.]+$/,'');
      const cid=gid();
      const contData={contentId:cid,title,categoryId:'',type,price:1000,url:rawUrl,thumbnailUrl:null,summary:'',sortOrder:0,isActive:true,viewCount:0,createdAt:serverTimestamp(),updatedAt:serverTimestamp()};
      if(type==='report'||type==='closing')contData.subType=subType;
      if(type==='report'){
        const baseName=title;
        const pdfInfo=reportPdfMap[baseName];
        const pptxInfo=reportPptxMap[baseName];
        if(pdfInfo)contData.pdfUrl=`https://raw.githubusercontent.com/${GH_REPO}/main/${pdfInfo.path}`;
        if(pptxInfo)contData.pptxUrl=`https://raw.githubusercontent.com/${GH_REPO}/main/${pptxInfo.path}`;
        if(!subType&&(pdfInfo||pptxInfo))contData.subType=(pdfInfo||pptxInfo).subType;
      }
      if(type==='closing'){
        const pdfKey=f.path.replace(/\.[^.]+$/,'');
        const pptxPath=pdfMap[pdfKey];
        contData.pptxUrl=pptxPath?`https://raw.githubusercontent.com/${GH_REPO}/main/${pptxPath}`:null;
        contData.videoUrl=null;
      }
      await setDoc(doc(db,'contents',cid),contData);added++;
      ss.textContent=`ë™ê¸°í™” ì¤‘... (${added}ê°œ ì¶”ê°€ / ${skipped}ê°œ ê±´ë„ˆëœ€)`;
    }
    ss.innerHTML=`<strong>âœ… ë™ê¸°í™” ì™„ë£Œ!</strong> ì‹ ê·œ ${added}ê°œ ë“±ë¡ / ${skipped}ê°œ ê±´ë„ˆëœ€ (ì´ë¯¸ ë“±ë¡ ë˜ëŠ” ì œì™¸)`;
    if(added>0)loadConts();
  }catch(err){ss.innerHTML=`<strong style="color:red">âŒ ë™ê¸°í™” ì‹¤íŒ¨:</strong> ${err.message}`;console.error(err);}
}

// â•â•â• BATCH UPLOAD â•â•â•
function showBatchUpload(){$('cf-area').classList.add('hidden');$('bulk-price-area').classList.add('hidden');$('batch-area').classList.remove('hidden');}
function switchBatchTab(tab,btn){btn.parentElement.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));btn.classList.add('active');$('batch-audio').style.display=tab==='audio'?'':'none';$('batch-video').style.display=tab==='video'?'':'none';}
// ì˜¤ë””ì˜¤ íŒŒì¼ ì„ íƒ ì‹œ ë¯¸ë¦¬ë³´ê¸° ëª©ë¡ í‘œì‹œ
function previewAudioFiles(){
  const files=$('ba-files').files;
  const prev=$('ba-preview');
  const btn=$('ba-upload-btn');
  if(!files.length){prev.innerHTML='';btn.style.display='none';return;}
  let html='<div style="font-size:13px;color:var(--text-lt);margin-bottom:8px">'+files.length+'ê°œ íŒŒì¼ ì„ íƒë¨ â€” ê° íŒŒì¼ì˜ êµ¬ë¶„(ê°œì¸/ë²•ì¸)ì„ ì„ íƒí•œ í›„ ì—…ë¡œë“œí•´ ì£¼ì„¸ìš”.</div>';
  html+='<div style="display:flex;gap:4px;margin-bottom:8px"><button type="button" class="btn btn-sm" onclick="baSetAll(\'ê°œì¸\')">ì „ì²´ â†’ ê°œì¸</button><button type="button" class="btn btn-sm" onclick="baSetAll(\'ë²•ì¸\')">ì „ì²´ â†’ ë²•ì¸</button><button type="button" class="btn btn-sm btn-sec" onclick="baSetAll(\'\')">ì „ì²´ â†’ ì—†ìŒ</button></div>';
  html+='<div class="tbl-wrap"><table class="tbl"><thead><tr><th style="width:40px">No</th><th>íŒŒì¼ëª… (ì œëª©)</th><th style="width:100px">êµ¬ë¶„</th></tr></thead><tbody>';
  for(let i=0;i<files.length;i++){
    const title=files[i].name.replace(/\.[^.]+$/,'').replace(/^íŒŸìºìŠ¤íŠ¸_/,'').replace(/_/g,' ');
    html+=`<tr><td style="text-align:center">${i+1}</td><td>${esc(title)}</td><td><select id="ba-sub-${i}" style="padding:4px 8px;border:1px solid var(--border);border-radius:4px;font-size:13px"><option value="">ì—†ìŒ</option><option value="ê°œì¸">ê°œì¸</option><option value="ë²•ì¸">ë²•ì¸</option></select></td></tr>`;
  }
  html+='</tbody></table></div>';
  prev.innerHTML=html;
  btn.style.display='';
}
function baSetAll(v){
  const files=$('ba-files').files;
  for(let i=0;i<files.length;i++){const sel=$('ba-sub-'+i);if(sel)sel.value=v;}
}
async function batchAudioUpload(){
  const files=$('ba-files').files;if(!files.length){toast('ì˜¤ë””ì˜¤ íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”.','error');return;}
  const catId=$('ba-cat').value;const price=parseInt($('ba-price').value)||1000;
  const prog=$('ba-progress');prog.innerHTML='<div style="font-size:13px">ê¸°ì¡´ ì½˜í…ì¸  í™•ì¸ ì¤‘...</div>';
  const cSnap=await getDocs(collection(db,'contents'));const existUrls=new Set(cSnap.docs.map(d=>(d.data().url||'')));
  let done=0,fail=0,dup=0;const total=files.length;prog.innerHTML='';
  for(let i=0;i<files.length;i++){
    const file=files[i];
    const title=file.name.replace(/\.[^.]+$/,'').replace(/^íŒŸìºìŠ¤íŠ¸_/,'').replace(/_/g,' ');
    const subtype=($('ba-sub-'+i)?.value)||'';
    const cleanName=file.name.replace(/[^a-zA-Z0-9ê°€-í£._-]/g,'');
    const isDup=[...existUrls].some(u=>u.includes(cleanName));
    if(isDup){dup++;prog.innerHTML=`<div style="margin:4px 0;font-size:13px;color:var(--warning)">â­ (${i+1}/${total}) ${esc(title)} - ì´ë¯¸ ë“±ë¡ë¨</div>`+prog.innerHTML;continue;}
    prog.innerHTML=`<div style="margin:4px 0;font-size:13px">â³ (${i+1}/${total}) ${esc(title)} ì—…ë¡œë“œ ì¤‘...</div>`+prog.innerHTML;
    try{
      const path='audio/'+Date.now()+'_'+cleanName;
      const sR=stRef(storage,path);const task=uploadBytesResumable(sR,file,{contentType:file.type});
      await new Promise((resolve,reject)=>{task.on('state_changed',null,reject,resolve);});
      const url=await getDownloadURL(task.snapshot.ref);existUrls.add(url);
      const cid=gid();
      const data={contentId:cid,title,categoryId:catId,type:'audio',price,url,thumbnailUrl:null,summary:title,sortOrder:0,isActive:true,viewCount:0,createdAt:serverTimestamp(),updatedAt:serverTimestamp()};
      if(subtype==='ê°œì¸'||subtype==='ë²•ì¸')data.subType=subtype;
      await setDoc(doc(db,'contents',cid),data);
      done++;prog.innerHTML=`<div style="margin:4px 0;font-size:13px;color:var(--success)">âœ… (${i+1}/${total}) ${esc(title)} [${subtype||'êµ¬ë¶„ì—†ìŒ'}]</div>`+prog.innerHTML.replace(/â³[^<]*<\/div>/,'');
    }catch(e){fail++;prog.innerHTML=`<div style="margin:4px 0;font-size:13px;color:var(--danger)">âŒ (${i+1}/${total}) ${esc(title)} - ${e.message}</div>`+prog.innerHTML.replace(/â³[^<]*<\/div>/,'');}
  }
  prog.innerHTML=`<div style="margin:8px 0;font-size:14px;font-weight:600">ì™„ë£Œ! ì„±ê³µ ${done}ê°œ / ì¤‘ë³µ ${dup}ê°œ / ì‹¤íŒ¨ ${fail}ê°œ</div>`+prog.innerHTML;
  if(done>0)loadConts();$('ba-files').value='';$('ba-preview').innerHTML='';$('ba-upload-btn').style.display='none';
}
async function batchVideoUpload(){
  const fileInput=$('bv-file');const file=fileInput.files[0];if(!file){toast('ì—‘ì…€ íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”.','error');return;}
  const price=parseInt($('bv-price').value)||1000;const prog=$('bv-progress');prog.innerHTML='<div style="font-size:13px">ğŸ“„ ì—‘ì…€ íŒŒì¼ ì½ëŠ” ì¤‘...</div>';
  try{
    const ab=await file.arrayBuffer();
    const XLSX=await import('https://cdn.sheetjs.com/xlsx-0.20.0/package/xlsx.mjs');
    const wb=XLSX.read(ab,{type:'array'});const ws=wb.Sheets[wb.SheetNames[0]];const rows=XLSX.utils.sheet_to_json(ws,{header:1});
    const catSnap=await getDocs(query(collection(db,'categories'),orderBy('sortOrder')));const catMap={};catSnap.docs.forEach(d=>{const c=d.data();catMap[c.name]=c.categoryId;});
    const cSnap=await getDocs(collection(db,'contents'));const existUrls=new Set(cSnap.docs.map(d=>(d.data().url||'')));
    // 4ì—´(ì¹´í…Œê³ ë¦¬,êµ¬ë¶„,ì œëª©,URL) ë˜ëŠ” 3ì—´(ì¹´í…Œê³ ë¦¬,ì œëª©,URL) ìë™ ê°ì§€
    const firstRow=rows.find(r=>r.length>=3);
    const is4col=firstRow&&firstRow.length>=4&&String(firstRow[3]||'').trim().startsWith('http');
    let done=0,fail=0,skip=0,dup=0;
    const dataRows=is4col?rows.filter(r=>r.length>=4&&r[0]&&r[2]&&r[3]):rows.filter(r=>r.length>=3&&r[0]&&r[1]&&r[2]);
    prog.innerHTML=`<div style="font-size:13px">ì´ ${dataRows.length}ê°œ í–‰ ë°œê²¬ (${is4col?'4ì—´: ì¹´í…Œê³ ë¦¬/êµ¬ë¶„/ì œëª©/URL':'3ì—´: ì¹´í…Œê³ ë¦¬/ì œëª©/URL'}). ë“±ë¡ ì¤‘...</div>`;
    for(let i=0;i<dataRows.length;i++){
      const r=dataRows[i];
      let catName,subtype,title,url;
      if(is4col){catName=String(r[0]).trim();subtype=String(r[1]).trim();title=String(r[2]).trim();url=String(r[3]).trim();}
      else{catName=String(r[0]).trim();subtype='';title=String(r[1]).trim();url=String(r[2]).trim();}
      if(!url.startsWith('http')){skip++;continue;}
      if(existUrls.has(url)){dup++;continue;}
      const catId=catMap[catName]||'';
      try{
        const cid=gid();
        const data={contentId:cid,title,categoryId:catId,type:'video',price,url,thumbnailUrl:null,summary:title,sortOrder:0,isActive:true,viewCount:0,createdAt:serverTimestamp(),updatedAt:serverTimestamp()};
        if(subtype==='ê°œì¸'||subtype==='ë²•ì¸')data.subType=subtype;
        await setDoc(doc(db,'contents',cid),data);
        done++;existUrls.add(url);
      }catch(e){fail++;}
      if((i+1)%10===0)prog.innerHTML=`<div style="font-size:13px">ë“±ë¡ ì¤‘... ${i+1}/${dataRows.length}</div>`;
    }
    prog.innerHTML=`<div style="font-size:14px;font-weight:600">ì™„ë£Œ! ì„±ê³µ ${done}ê°œ / ì¤‘ë³µ ${dup}ê°œ / ì‹¤íŒ¨ ${fail}ê°œ / ê±´ë„ˆëœ€ ${skip}ê°œ</div>`;
    if(done>0)loadConts();fileInput.value='';
  }catch(e){prog.innerHTML=`<div style="color:var(--danger);font-size:13px">âŒ ì˜¤ë¥˜: ${e.message}</div>`;}
}

// â•â•â• CATEGORIES â•â•â•
async function loadCats(){const snap=await getDocs(query(collection(db,'categories'),orderBy('sortOrder')));$('tb-cats').innerHTML=snap.docs.map(d=>{const c=d.data();return`<tr><td>${esc(c.name)}</td><td>${c.sortOrder}</td><td>${c.isActive?'<span class="st-active">í™œì„±</span>':'<span class="st-suspended">ë¹„í™œì„±</span>'}</td><td><button class="btn btn-sm" onclick="toggleCat('${c.categoryId}',${c.isActive})">${c.isActive?'ë¹„í™œì„±':'í™œì„±'}</button> <button class="btn-danger" onclick="delCat('${c.categoryId}','${esc(c.name)}')">ì‚­ì œ</button></td></tr>`;}).join('');}
async function addCat(){const name=$('nc-name').value.trim();if(!name)return toast('ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.','error');const snap=await getDocs(collection(db,'categories'));const id=gid();await setDoc(doc(db,'categories',id),{categoryId:id,name,sortOrder:snap.size,isActive:true});$('nc-name').value='';toast('ì¶”ê°€ ì™„ë£Œ','success');loadCats();}
async function toggleCat(id,cur){await updateDoc(doc(db,'categories',id),{isActive:!cur});loadCats();}
async function delCat(id,name){if(!confirm('ì¹´í…Œê³ ë¦¬ "'+name+'"ì„(ë¥¼) ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nâš ï¸ í•´ë‹¹ ì¹´í…Œê³ ë¦¬ë¥¼ ì‚¬ìš© ì¤‘ì¸ ì½˜í…ì¸ ê°€ ìˆìœ¼ë©´ ì¹´í…Œê³ ë¦¬ê°€ í‘œì‹œë˜ì§€ ì•Šì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.'))return;await deleteDoc(doc(db,'categories',id));toast('ì‚­ì œ ì™„ë£Œ','success');loadCats();}

// â•â•â• PAYMENTS â•â•â•
async function loadPays(){const snap=await getDocs(query(collection(db,'payments'),orderBy('createdAt','desc'),limit(100)));const uc={};const rows=[];for(const d of snap.docs){const p=d.data();if(!uc[p.userId]){const u=await getDoc(doc(db,'users',p.userId));uc[p.userId]=u.exists()?u.data().name:p.userId;}rows.push(`<tr><td>${fdatetime(p.createdAt)}</td><td>${esc(uc[p.userId])}</td><td>${fmt(p.paidAmount)}ì›</td><td>${fmt(p.chargeAmount)}ì›</td><td>${p.status}</td></tr>`);}$('tb-pays').innerHTML=rows.join('');}

// â•â•â• LOGS â•â•â•
let _logs=[],_logCT={},_logAct={};
async function loadLogs(){
  const constraints=[orderBy('createdAt','desc')];const f=$('lg-from').value,t=$('lg-to').value;
  if(f)constraints.push(where('createdAt','>=',Timestamp.fromDate(new Date(f))));
  if(t){const td=new Date(t);td.setHours(23,59,59,999);constraints.push(where('createdAt','<=',Timestamp.fromDate(td)));}
  constraints.push(limit(500));
  const snap=await getDocs(query(collection(db,'view_logs'),...constraints));_logs=snap.docs.map(d=>({...d.data(),_id:d.id}));
  const uc={},cc={};_logCT={};_logAct={};let total=0;const rows=[];
  for(const l of _logs){if(!uc[l.userId]){const u=await getDoc(doc(db,'users',l.userId));uc[l.userId]=u.exists()?u.data().name:l.userId;}if(!cc[l.contentId]){const c=await getDoc(doc(db,'contents',l.contentId));if(c.exists()){cc[l.contentId]=c.data().title;_logCT[l.contentId]=c.data().type||'';}else{cc[l.contentId]=l.contentId;_logCT[l.contentId]='';}}const act=l.action||'view';_logAct[l._id]=act;total+=(l.price||0);rows.push(`<tr><td>${fdatetime(l.createdAt)}</td><td>${esc(uc[l.userId])}</td><td>${typeBadge(_logCT[l.contentId],act)}</td><td class="ov">${esc(cc[l.contentId])}</td><td>${l.price>0?fmt(l.price)+'ì›':'ë¬´ë£Œ'}</td></tr>`);}
  $('lg-summary').innerHTML=`<div class="dash-c"><span>ì´ ì—´ëŒìˆ˜</span><strong>${_logs.length}</strong></div><div class="dash-c"><span>ì´ ë§¤ì¶œ</span><strong>${fmt(total)}</strong><em>ì›</em></div>`;$('tb-logs').innerHTML=rows.join('');
}
function exportCSV(){if(!_logs.length)return toast('ë°ì´í„° ì—†ìŒ','error');const typeNm={video:'ì˜ìƒì½˜í…ì¸ ',brief:'ì´ìŠˆë¸Œë¦¬í•‘',audio:'ì˜¤ë””ì˜¤',report:'íŠ¹ê¸‰ë³´ê³ ì„œ',closing:'í´ë¡œì§•PDF'};let csv='\uFEFFë‚ ì§œ,ì‚¬ìš©ìID,ì½˜í…ì¸ ëª…ì¹­,ì½˜í…ì¸ ID,ì°¨ê°ì•¡\n';_logs.forEach(l=>{let tName=typeNm[_logCT[l.contentId]]||'';if(_logCT[l.contentId]==='closing'&&_logAct[l._id]==='ppt_download')tName='í´ë¡œì§•PPT';csv+=`${fdatetime(l.createdAt)},${l.userId},${tName},${l.contentId},${l.price||0}\n`;});const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='javia_logs_'+new Date().toISOString().slice(0,10)+'.csv';a.click();}

// â•â•â• PROPOSALS â•â•â•
async function loadProps(){const snap=await getDocs(query(collection(db,'partner_proposals'),orderBy('createdAt','desc')));const sl={new:'ì‹ ê·œ',reviewing:'ê²€í† ì¤‘',done:'ì™„ë£Œ'};$('tb-props').innerHTML=snap.docs.map(d=>{const p=d.data();return`<tr><td>${fdate(p.createdAt)}</td><td>${esc(p.userNameSnapshot)}</td><td class="ov">${esc(p.title)}</td><td><span class="st-${p.status}">${sl[p.status]||p.status}</span></td><td><button class="btn btn-sm" onclick="showProp('${p.proposalId}')">ìƒì„¸</button></td></tr>`;}).join('');}
async function showProp(pid){const d=await getDoc(doc(db,'partner_proposals',pid));if(!d.exists())return;const p=d.data();
  let userInfo='';
  try{const uDoc=await getDoc(doc(db,'users',p.userId));if(uDoc.exists()){const u=uDoc.data();userInfo=`<div class="info-grid" style="margin-bottom:16px"><div><label>ì´ë¦„:</label>${esc(u.name)}</div><div><label>ì•„ì´ë””:</label>${esc(u.loginId||'')}</div><div><label>ì†Œì†:</label>${esc(u.company||'')}</div><div><label>ì§í•¨:</label>${esc(u.title||'')}</div><div><label>ì—°ë½ì²˜:</label>${esc(u.phone||'')}</div><div><label>ì´ë©”ì¼:</label>${esc(u.email||'')}</div></div>`;}}catch(e){}
  $('prop-inner').innerHTML=`<h2>${esc(p.title)}</h2><p style="color:#888;margin-bottom:16px">ì œì•ˆì: ${esc(p.userNameSnapshot)} | ì ‘ìˆ˜ì¼: ${fdate(p.createdAt)}</p>${userInfo}<div style="white-space:pre-wrap;word-break:break-all;line-height:1.8;padding:16px;background:var(--bg);border-radius:8px;margin-bottom:20px">${esc(p.body)}</div><div class="fg"><label>ìƒíƒœ ë³€ê²½</label><select id="ps-${pid}"><option value="new" ${p.status==='new'?'selected':''}>ì‹ ê·œ</option><option value="reviewing" ${p.status==='reviewing'?'selected':''}>ê²€í† ì¤‘</option><option value="done" ${p.status==='done'?'selected':''}>ì™„ë£Œ</option></select></div><div class="fg"><label>ë‚´ë¶€ ë©”ëª¨</label><textarea id="pm-${pid}" rows="3">${esc(p.adminMemo||'')}</textarea></div><button class="btn" onclick="updateProp('${pid}')">ì €ì¥</button>`;openM('mdl-prop');}
async function updateProp(pid){await updateDoc(doc(db,'partner_proposals',pid),{status:$('ps-'+pid).value,adminMemo:$('pm-'+pid).value.trim(),updatedAt:serverTimestamp()});toast('ì—…ë°ì´íŠ¸ ì™„ë£Œ','success');closeM('mdl-prop');loadProps();}

// â•â•â• NOTICES â•â•â•
async function loadNoticesAdm(){const snap=await getDocs(query(collection(db,'notices'),orderBy('createdAt','desc')));$('tb-notices').innerHTML=snap.docs.map((d,i)=>{const n=d.data();return`<tr><td>${i+1}</td><td>${esc(n.title)}</td><td>${n.isActive?'<span class="st-active">ë…¸ì¶œ</span>':'<span class="st-suspended">ë¹„ë…¸ì¶œ</span>'}</td><td>${fdate(n.createdAt)}</td><td><button class="btn btn-sm" onclick="editNotice('${n.noticeId}')">ìˆ˜ì •</button></td></tr>`;}).join('');}
function showNF(){$('nf-area').classList.remove('hidden');$('nf-id').value='';$('nf-title').value='';$('nf-body').innerHTML='';$('nf-preview').style.display='none';}
async function editNotice(nid){const d=await getDoc(doc(db,'notices',nid));if(!d.exists())return;const n=d.data();$('nf-id').value=nid;$('nf-title').value=n.title;$('nf-body').innerHTML=n.bodyHtml||n.body||'';$('nf-active').value=n.isActive?'1':'0';$('nf-area').classList.remove('hidden');$('nf-preview').style.display='none';}
async function saveNotice(e){if(e&&e.preventDefault)e.preventDefault();const nid=$('nf-id').value||gid();const bodyHtml=$('nf-body').innerHTML.trim();const bodyText=$('nf-body').innerText.trim();if(!$('nf-title').value.trim()||!bodyText){toast('ì œëª©ê³¼ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.','error');return;}const data={noticeId:nid,title:$('nf-title').value.trim(),body:bodyText,bodyHtml:bodyHtml,isActive:$('nf-active').value==='1',updatedAt:serverTimestamp()};if(!$('nf-id').value){data.createdBy=admUser.uid;data.createdAt=serverTimestamp();}await setDoc(doc(db,'notices',nid),data,{merge:true});toast('ê³µì§€ ì €ì¥ ì™„ë£Œ','success');$('nf-area').classList.add('hidden');loadNoticesAdm();}
function nfPreview(){$('nf-preview-body').innerHTML=$('nf-body').innerHTML;$('nf-preview').style.display='block';}

// â•â•â• RICH EDITOR (ê³µí†µ) â•â•â•
function richFmt(type,valOrTarget,target){
  // richFmt('bold','nf-body') ë˜ëŠ” richFmt('fontSize','3','nf-body')
  let editorId=target||valOrTarget;
  let val=target?valOrTarget:null;
  const editor=$(editorId);if(!editor)return;
  editor.focus();
  if(type==='bold')document.execCommand('bold',false,null);
  else if(type==='italic')document.execCommand('italic',false,null);
  else if(type==='underline')document.execCommand('underline',false,null);
  else if(type==='fontSize'){if(val)document.execCommand('fontSize',false,val);}
  else if(type==='h2')document.execCommand('formatBlock',false,'<h2>');
  else if(type==='h3')document.execCommand('formatBlock',false,'<h3>');
  else if(type==='color'){const colorId=editorId.replace('-body','-color');const c=$(colorId)?$(colorId).value:'#2E86AB';if(c)document.execCommand('foreColor',false,c);}
  else if(type==='justifyLeft')document.execCommand('justifyLeft',false,null);
  else if(type==='justifyCenter')document.execCommand('justifyCenter',false,null);
  else if(type==='justifyRight')document.execCommand('justifyRight',false,null);
  else if(type==='ul')document.execCommand('insertUnorderedList',false,null);
  else if(type==='ol')document.execCommand('insertOrderedList',false,null);
  else if(type==='hr')document.execCommand('insertHTML',false,'<hr style="border:none;border-top:1px solid #ddd;margin:12px 0">');
  else if(type==='link'){const url=prompt('URLì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: https://...)');if(url){const txt=document.getSelection().toString()||url;document.execCommand('insertHTML',false,`<a href="${url}" target="_blank" style="color:#2E86AB;text-decoration:underline">${txt}</a>`);}}
  else if(type==='image'){const url=prompt('ì´ë¯¸ì§€ URLì„ ì…ë ¥í•˜ì„¸ìš”');if(url)document.execCommand('insertHTML',false,`<img src="${url}" style="max-width:100%;height:auto;border-radius:4px;margin:8px 0">`);}
  else if(type==='undo')document.execCommand('undo',false,null);
  else if(type==='redo')document.execCommand('redo',false,null);
  editor.focus();
}
window.richFmt=richFmt;window.nfPreview=nfPreview;

// â•â•â• TERMS â•â•â•
async function loadGuide(){try{const d=await getDoc(doc(db,'guide','main'));if(d.exists()){const g=d.data();$('gd-title').value=g.title||'ì´ìš© ê°€ì´ë“œ';$('gd-body').innerHTML=g.bodyHtml||'';$('gd-preview').style.display='none';}else{$('gd-title').value='ì´ìš© ê°€ì´ë“œ';$('gd-body').innerHTML='';$('gd-preview').style.display='none';}}catch(e){console.error('guide load fail:',e);}}
async function saveGuide(){const data={title:$('gd-title').value.trim(),bodyHtml:$('gd-body').innerHTML,updatedBy:admUser.uid,updatedAt:serverTimestamp()};try{await setDoc(doc(db,'guide','main'),data,{merge:true});toast('ê°€ì´ë“œ ì €ì¥ ì™„ë£Œ','success');}catch(e){toast('ì €ì¥ ì‹¤íŒ¨: '+e.message,'error');}}
function gdPreview(){$('gd-preview-body').innerHTML=$('gd-body').innerHTML;$('gd-preview').style.display='block';}
async function loadTermEdit(type,btn){if(btn){btn.parentElement.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));btn.classList.add('active');}$('te-type').value=type;try{const snap=await getDocs(query(collection(db,'terms'),where('type','==',type),where('isActive','==',true),orderBy('version','desc'),limit(1)));$('te-body').value=snap.empty?'':snap.docs[0].data().content;}catch(e){console.warn('terms index fallback:',e);const snap2=await getDocs(collection(db,'terms'));const list=snap2.docs.map(d=>d.data()).filter(t=>t.type===type&&t.isActive).sort((a,b)=>(b.version||0)-(a.version||0));$('te-body').value=list.length?list[0].content:'';}}
async function saveTerm(e){e.preventDefault();const type=$('te-type').value,content=$('te-body').value.trim();const exSnap=await getDocs(query(collection(db,'terms'),where('type','==',type),where('isActive','==',true)));let ver=1;if(!exSnap.empty){ver=(exSnap.docs[0].data().version||0)+1;for(const d of exSnap.docs)await updateDoc(d.ref,{isActive:false});}const tid=gid();await setDoc(doc(db,'terms',tid),{termId:tid,type,content,version:ver,isActive:true,updatedBy:admUser.uid,createdAt:serverTimestamp(),updatedAt:serverTimestamp()});toast('ì•½ê´€ ì €ì¥ ì™„ë£Œ (v'+ver+')','success');}

// â•â•â• CHARGE OPTIONS â•â•â•
async function loadChargeOpts(){const snap=await getDocs(query(collection(db,'charge_options'),orderBy('sortOrder')));$('tb-copts').innerHTML=snap.docs.map(d=>{const o=d.data();return`<tr><td>${fmt(o.paidAmount)}ì›</td><td>${fmt(o.chargeAmount)}ì›</td><td>${esc(o.label||'')}</td><td>${o.sortOrder}</td><td>${o.isActive?'<span class="st-active">í™œì„±</span>':'<span class="st-suspended">ë¹„í™œì„±</span>'}</td><td><button class="btn btn-sm" onclick="toggleCO('${o.optionId}',${o.isActive})">${o.isActive?'ë¹„í™œì„±':'í™œì„±'}</button> <button class="btn btn-sm btn-danger" onclick="delCO('${o.optionId}')">ì‚­ì œ</button></td></tr>`;}).join('');}
async function addChargeOpt(){const paid=parseInt($('co-paid').value),credit=parseInt($('co-credit').value),label=$('co-label').value.trim();if(!paid||!credit)return toast('ê¸ˆì•¡ì„ ì…ë ¥í•˜ì„¸ìš”.','error');const snap=await getDocs(collection(db,'charge_options'));const id=gid();await setDoc(doc(db,'charge_options',id),{optionId:id,paidAmount:paid,chargeAmount:credit,label:label||fmt(paid)+'ì›',sortOrder:snap.size,isActive:true});$('co-paid').value='';$('co-credit').value='';$('co-label').value='';toast('ì¶”ê°€ ì™„ë£Œ','success');loadChargeOpts();}
async function toggleCO(id,cur){await updateDoc(doc(db,'charge_options',id),{isActive:!cur});loadChargeOpts();}
async function delCO(id){if(!confirm('ì‚­ì œ?'))return;await deleteDoc(doc(db,'charge_options',id));toast('ì‚­ì œ ì™„ë£Œ','success');loadChargeOpts();}

// â•â•â• WINDOW EXPORTS â•â•â•
window.admLogout=admLogout;window.goPanel=goPanel;window.openM=openM;window.closeM=closeM;
window.showAddUser=showAddUser;window.createFreeUser=createFreeUser;window.setExpPeriod=setExpPeriod;
window.nuEmailSel=nuEmailSel;window.nuUnlimitedChk=nuUnlimitedChk;window.initNuDates=initNuDates;

// â”€â”€ Enterí‚¤: ë‹¤ìŒ ì…ë ¥ì°½ ì´ë™ â”€â”€
document.addEventListener('keydown',e=>{
  if(e.key==='Enter'&&e.target.tagName==='INPUT'&&!e.target.closest('form')){
    e.preventDefault();const nxt=e.target.dataset.next;if(nxt&&$(nxt)){$(nxt).focus();}
  }
  if(e.key==='Enter'&&e.target.tagName==='INPUT'&&e.target.closest('form')&&e.target.type!=='submit'){
    e.preventDefault();const inputs=[...e.target.closest('form').querySelectorAll('input,select,textarea')];
    const idx=inputs.indexOf(e.target);if(idx>=0&&idx<inputs.length-1)inputs[idx+1].focus();
  }
});
window.loadMembers=loadMembers;window.showMember=showMember;window.toggleStatus=toggleStatus;window.doAdjust=doAdjust;window.doAdjustPoint=doAdjustPoint;window.updateMemberInfo=updateMemberInfo;window.changeMemberPw=changeMemberPw;window.updateJarviaMember=updateJarviaMember;
async function updateJarviaMember(uid){
  const regFee=$('ed-regfee-'+uid).value==='paid';
  const monthlyFee=parseInt($('ed-monthly-'+uid).value)||50000;
  try{await updateDoc(doc(db,'users',uid),{regFeePaid:regFee,monthlyFee,updatedAt:serverTimestamp()});
    toast('JARVIAë©¤ë²„ì‹­ ì •ë³´ ì €ì¥ ì™„ë£Œ','success');
  }catch(e){toast('ì €ì¥ ì‹¤íŒ¨: '+e.message,'error');}
}
window.toggleAllMembers=toggleAllMembers;window.deleteSelectedMembers=deleteSelectedMembers;
window.loadAdmins=loadAdmins;window.createAdmin=createAdmin;window.delAdmin=delAdmin;
window.showCF=showCF;window.editCont=editCont;window.delCont=delCont;window.saveCont=saveCont;window.loadConts=loadConts;window.onCfTypeChange=onCfTypeChange;window.uploadAudio=uploadAudio;window.syncGitHub=syncGitHub;window.renderConts=renderConts;window.contPg=contPg;window.toggleAllChk=toggleAllChk;window.delSelected=delSelected;
window.showBatchUpload=showBatchUpload;window.switchBatchTab=switchBatchTab;window.previewAudioFiles=previewAudioFiles;window.baSetAll=baSetAll;window.batchAudioUpload=batchAudioUpload;window.batchVideoUpload=batchVideoUpload;
function toggleBulkPrice(){$('cf-area').classList.add('hidden');$('batch-area').classList.add('hidden');$('bulk-price-area').classList.toggle('hidden');$('bp-result').innerHTML='';}
async function bulkPricePreview(){
  const dp=parseInt($('bp-default').value)||0;const cp=parseInt($('bp-closing').value)||0;
  const snap=await getDocs(collection(db,'contents'));let lines=[];let cnt=0;
  snap.docs.forEach(d=>{const c=d.data();const np=c.type==='closing'?cp:dp;if(c.price!==np){lines.push(`${c.type} | ${c.title} | ${fmt(c.price)}ì› â†’ ${fmt(np)}ì›`);cnt++;}});
  $('bp-result').innerHTML=cnt?`<div style="max-height:300px;overflow-y:auto;background:#f9f9f9;padding:12px;border-radius:8px;white-space:pre-line;font-size:12px">${lines.join('\n')}</div><div style="margin-top:8px;font-weight:600">ì´ ${cnt}ê±´ ë³€ê²½ ì˜ˆì •</div>`:'<div>ë³€ê²½í•  í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
}
async function bulkPriceApply(){
  const dp=parseInt($('bp-default').value)||0;const cp=parseInt($('bp-closing').value)||0;
  if(!confirm(`ê¸°ë³¸ ${fmt(dp)}ì› / í´ë¡œì§•PPT ${fmt(cp)}ì›ìœ¼ë¡œ ì¼ê´„ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`))return;
  const snap=await getDocs(collection(db,'contents'));let cnt=0;
  for(const d of snap.docs){const c=d.data();const np=c.type==='closing'?cp:dp;if(c.price!==np){await updateDoc(doc(db,'contents',c.contentId),{price:np,updatedAt:serverTimestamp()});cnt++;}}
  $('bp-result').innerHTML=`<div style="color:var(--success);font-weight:600">âœ… ${cnt}ê±´ ê°€ê²© ë³€ê²½ ì™„ë£Œ!</div>`;
  if(cnt>0)loadConts();
}
window.toggleBulkPrice=toggleBulkPrice;window.bulkPricePreview=bulkPricePreview;window.bulkPriceApply=bulkPriceApply;
window.addCat=addCat;window.toggleCat=toggleCat;window.delCat=delCat;window.loadCats=loadCats;
window.loadPays=loadPays;window.loadLogs=loadLogs;window.exportCSV=exportCSV;
window.loadProps=loadProps;window.showProp=showProp;window.updateProp=updateProp;
window.showNF=showNF;window.editNotice=editNotice;window.saveNotice=saveNotice;window.loadNoticesAdm=loadNoticesAdm;
window.loadTermEdit=loadTermEdit;window.saveTerm=saveTerm;
window.loadGuide=loadGuide;window.saveGuide=saveGuide;window.gdPreview=gdPreview;
window.loadChargeOpts=loadChargeOpts;window.addChargeOpt=addChargeOpt;window.toggleCO=toggleCO;window.delCO=delCO;

// â•â•â• THUMBNAIL SETTINGS â•â•â•
const TH_TYPES=[{key:'video',label:'ğŸ¬ ì˜ìƒì½˜í…ì¸ '},{key:'brief',label:'ğŸ“° ì´ìŠˆë¸Œë¦¬í•‘'},{key:'audio',label:'ğŸ§ ì˜¤ë””ì˜¤'},{key:'report',label:'ğŸ“Š íŠ¹ê¸‰ë³´ê³ ì„œ'},{key:'closing',label:'ğŸ“‘ í´ë¡œì§•PPT'}];
function toggleThDate(){$('th-date-wrap').style.display=$('th-scope').value==='after'?'':'none';}
async function loadThumbs(){
  let data={};try{const d=await getDoc(doc(db,'settings','thumb_settings'));if(d.exists())data=d.data();}catch(e){}
  $('th-scope').value=data.scope||'all';$('th-date').value=data.afterDate||'';toggleThDate();
  $('th-types').innerHTML=TH_TYPES.map(t=>`<div class="fr" style="align-items:center;margin-bottom:12px"><div class="fg" style="flex:0 0 140px"><strong>${t.label}</strong></div><div class="fg"><input id="th-url-${t.key}" type="url" placeholder="ì´ë¯¸ì§€ URL" value="${esc(data[t.key]||'')}"></div><div class="fg" style="flex:0 0 100px">${data[t.key]?`<img src="${esc(data[t.key])}" style="height:50px;border-radius:4px">`:''}</div></div>`).join('');
}
async function saveThumbs(){
  const data={scope:$('th-scope').value,afterDate:$('th-scope').value==='after'?$('th-date').value:'',updatedAt:serverTimestamp()};
  TH_TYPES.forEach(t=>{const el=$('th-url-'+t.key);data[t.key]=el?toFileUrl(el.value.trim())||null:null;});
  await setDoc(doc(db,'settings','thumb_settings'),data);toast('ì¸ë„¤ì¼ ì„¤ì • ì €ì¥ ì™„ë£Œ','success');loadThumbs();
}
window.loadThumbs=loadThumbs;window.saveThumbs=saveThumbs;window.toggleThDate=toggleThDate;

// â•â•â• REFERRAL STATUS â•â•â•
function setRefPeriod(type){
  const now=new Date();const y=now.getFullYear(),m=now.getMonth(),d=now.getDate();
  let from,to;
  if(type==='today'){from=to=new Date(y,m,d);}
  else if(type==='week'){const day=now.getDay()||7;from=new Date(y,m,d-day+1);to=new Date(y,m,d);}
  else if(type==='month'){from=new Date(y,m,1);to=new Date(y,m,d);}
  else{$('rs-from').value='';$('rs-to').value='';loadRefStatus();return;}
  $('rs-from').value=from.getFullYear()+'-'+String(from.getMonth()+1).padStart(2,'0')+'-'+String(from.getDate()).padStart(2,'0');
  $('rs-to').value=to.getFullYear()+'-'+String(to.getMonth()+1).padStart(2,'0')+'-'+String(to.getDate()).padStart(2,'0');
  loadRefStatus();
}
async function loadRefStatus(){
  try{
    const snap=await getDocs(query(collection(db,'transactions'),where('type','==','referral_reward')));
    const fromVal=$('rs-from').value,toVal=$('rs-to').value;
    const fromD=fromVal?new Date(fromVal+'T00:00:00'):null;
    const toD=toVal?new Date(toVal+'T23:59:59'):null;
    let txList=snap.docs.map(d=>({id:d.id,...d.data()}));
    txList.sort((a,b)=>(b.createdAt?.toMillis?.()||0)-(a.createdAt?.toMillis?.()||0));
    if(fromD)txList=txList.filter(t=>{const td=t.createdAt?.toDate?.();return td&&td>=fromD;});
    if(toD)txList=txList.filter(t=>{const td=t.createdAt?.toDate?.();return td&&td<=toD;});
    const uSnap=await getDocs(collection(db,'users'));
    const uMap={};uSnap.docs.forEach(d=>{const ud=d.data();uMap[d.id]={name:ud.name||'',loginId:ud.loginId||'',point:ud.point||0};});
    const refMap={};
    txList.forEach(t=>{
      const uid=t.userId;
      if(!refMap[uid])refMap[uid]={name:uMap[uid]?.name||'',loginId:uMap[uid]?.loginId||'',count:0,totalPts:0,currentPt:uMap[uid]?.point||0};
      refMap[uid].count++;refMap[uid].totalPts+=t.amount||0;
    });
    const totalCount=txList.length;
    const totalPts=txList.reduce((s,t)=>s+(t.amount||0),0);
    $('rs-summary').innerHTML=`<div class="dash-card"><div class="dc-num">${totalCount}ëª…</div><div class="dc-label">ì¶”ì²œ ì„±ê³µ ê±´ìˆ˜</div></div><div class="dash-card"><div class="dc-num" style="color:var(--success)">${fmt(totalPts)}P</div><div class="dc-label">ì§€ê¸‰ í¬ì¸íŠ¸ í•©ê³„</div></div><div class="dash-card"><div class="dc-num">${Object.keys(refMap).length}ëª…</div><div class="dc-label">ì¶”ì²œì ìˆ˜</div></div>`;
    const refArr=Object.entries(refMap).sort((a,b)=>b[1].totalPts-a[1].totalPts);
    $('tb-ref-summary').innerHTML=refArr.length?refArr.map(([uid,r])=>`<tr><td>${esc(r.name)}</td><td>${esc(r.loginId)}</td><td>${r.count}ëª…</td><td style="color:var(--success);font-weight:600">${fmt(r.totalPts)}P</td><td>${fmt(r.currentPt)}P</td></tr>`).join(''):'<tr><td colspan="5" class="tc">ë°ì´í„° ì—†ìŒ</td></tr>';
    $('tb-ref-detail').innerHTML=txList.length?txList.map(t=>{
      const refName=uMap[t.userId]?.name||'';
      const dt=t.createdAt?.toDate?.();
      const dtStr=dt?dt.getFullYear()+'. '+(dt.getMonth()+1)+'. '+dt.getDate()+'. '+dt.toLocaleTimeString('ko-KR',{hour:'2-digit',minute:'2-digit'}):'';
      return`<tr><td>${dtStr}</td><td>${esc(refName)}</td><td>${esc(t.memo||'')}</td><td>JARVIAë©¤ë²„ì‹­</td><td style="color:var(--success);font-weight:600">${fmt(t.amount||0)}P</td></tr>`;
    }).join(''):'<tr><td colspan="5" class="tc">ë°ì´í„° ì—†ìŒ</td></tr>';
  }catch(e){console.error('ì¶”ì²œí˜„í™© ë¡œë“œ ì‹¤íŒ¨:',e);toast('ì¶”ì²œí˜„í™© ë¡œë“œ ì‹¤íŒ¨','error');}
}
window.loadRefStatus=loadRefStatus;window.setRefPeriod=setRefPeriod;

// â•â•â• REFERRAL SETTINGS â•â•â•
async function loadRefSet(){
  try{const d=await getDoc(doc(db,'settings','referral_settings'));const data=d.exists()?d.data():{};
    const roles=data.allowedRoles||['jarvia_member'];
    $('ref-role-jarvia').checked=roles.includes('jarvia_member');
    $('ref-role-inner').checked=roles.includes('inner_circle');
    $('ref-role-user').checked=roles.includes('user');
    $('ref-role-free').checked=roles.includes('free_user');
    $('ref-role-branch').checked=roles.includes('branch_manager');
    $('ref-reward').value=data.rewardPoints||50000;
  }catch(e){console.error('ì¶”ì²œì„¤ì • ë¡œë“œ ì‹¤íŒ¨:',e);}
}
async function saveRefSet(){
  const roles=[];
  if($('ref-role-jarvia').checked)roles.push('jarvia_member');
  if($('ref-role-inner').checked)roles.push('inner_circle');
  if($('ref-role-user').checked)roles.push('user');
  if($('ref-role-free').checked)roles.push('free_user');
  if($('ref-role-branch').checked)roles.push('branch_manager');
  if(!roles.length)return toast('ìµœì†Œ 1ê°œ íšŒì›ìœ í˜•ì„ ì„ íƒí•˜ì„¸ìš”.','error');
  const pts=parseInt($('ref-reward').value)||50000;
  try{await setDoc(doc(db,'settings','referral_settings'),{allowedRoles:roles,rewardPoints:pts,updatedAt:serverTimestamp()});toast('ì¶”ì²œ ì„¤ì • ì €ì¥ ì™„ë£Œ','success');}catch(e){toast('ì €ì¥ ì‹¤íŒ¨: '+e.message,'error');}
}
window.loadRefSet=loadRefSet;window.saveRefSet=saveRefSet;

// â•â•â• ê²Œì‹œì˜ˆì •ì½˜í…ì¸  ê´€ë¦¬ â•â•â•
function showUF(id){
  $('uf-area').classList.remove('hidden');$('uf-id').value=id||'';
  if(!id){$('uf-date').value='';$('uf-cat').value='í´ë¡œì§•PPT';$('uf-field').value='ê°œì¸';$('uf-title').value='';$('uf-video').value='';$('uf-audio').value='';$('uf-html').value='';$('uf-pdf').value='';$('uf-ppt').value='';}
}
async function saveUpcoming(){
  if(!$('uf-date').value||!$('uf-title').value){toast('ê²Œì‹œì˜ˆì •ì¼ê³¼ ì œëª©ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.','error');return;}
  const id=$('uf-id').value||doc(collection(db,'upcoming_contents')).id;
  await setDoc(doc(db,'upcoming_contents',id),{
    date:$('uf-date').value,category:$('uf-cat').value,field:$('uf-field').value,title:$('uf-title').value,
    video:$('uf-video').value==='O',audio:$('uf-audio').value==='O',html:$('uf-html').value==='O',
    pdf:$('uf-pdf').value==='O',ppt:$('uf-ppt').value==='O',
    updatedAt:serverTimestamp()
  });
  toast('ì €ì¥ ì™„ë£Œ','success');$('uf-area').classList.add('hidden');loadUpcomingAdm();
}
async function loadUpcomingAdm(){
  const snap=await getDocs(query(collection(db,'upcoming_contents'),orderBy('date','asc')));
  const ck=v=>v?'<span style="color:#2e86ab;font-weight:700">âœ“</span>':'';
  const fmtDate=d=>(d||'').replace(/-/g,'.');
  const catBadge=c=>{const colors={'í´ë¡œì§•PPT':['#fce4e4','#c0392b'],'íŠ¹ê¸‰ë³´ê³ ì„œ':['#ddeef9','#1a6fa0'],'ì´ìŠˆë¸Œë¦¬í•‘':['#def5e6','#1e8449'],'ì˜ìƒì½˜í…ì¸ ':['#f0e4f7','#6c3483'],'ì˜¤ë””ì˜¤':['#fef3de','#d68910']};const cl=colors[c]||['#eee','#666'];return`<span style="display:inline-block;padding:2px 8px;border-radius:12px;font-size:11px;font-weight:600;white-space:nowrap;color:${cl[1]};background:${cl[0]}">${c}</span>`;};
  $('tb-upcoming').innerHTML=snap.empty?'<tr><td colspan="10" style="text-align:center;padding:20px;color:#999">ë“±ë¡ëœ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>':snap.docs.map((d,i)=>{const c=d.data();const bg=i%2===1?'background:#f8f9fa':'';return`<tr style="${bg};border-bottom:1px solid #e9ecef"><td style="text-align:center">${fmtDate(c.date)}</td><td style="text-align:center">${catBadge(c.category||'')}</td><td style="text-align:center">${c.field||''}</td><td style="text-align:left">${c.title||''}</td><td style="text-align:center">${ck(c.video)}</td><td style="text-align:center">${ck(c.audio)}</td><td style="text-align:center">${ck(c.html)}</td><td style="text-align:center">${ck(c.pdf)}</td><td style="text-align:center">${ck(c.ppt)}</td><td style="text-align:center"><div style="display:flex;gap:4px;justify-content:center;flex-wrap:nowrap"><button class="btn btn-sm" onclick="editUpcoming('${d.id}')">ìˆ˜ì •</button><button class="btn btn-sm btn-danger" onclick="delUpcoming('${d.id}')">ì‚­ì œ</button></div></td></tr>`;}).join('');
}
async function editUpcoming(id){
  const d=await getDoc(doc(db,'upcoming_contents',id));if(!d.exists())return;
  const c=d.data();showUF(id);
  $('uf-date').value=c.date||'';$('uf-cat').value=c.category||'í´ë¡œì§•PPT';$('uf-field').value=c.field||'ê°œì¸';$('uf-title').value=c.title||'';
  $('uf-video').value=c.video?'O':'';$('uf-audio').value=c.audio?'O':'';$('uf-html').value=c.html?'O':'';$('uf-pdf').value=c.pdf?'O':'';$('uf-ppt').value=c.ppt?'O':'';
}
async function delUpcoming(id){if(!confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?'))return;await deleteDoc(doc(db,'upcoming_contents',id));toast('ì‚­ì œ ì™„ë£Œ','success');loadUpcomingAdm();}
window.showUF=showUF;window.saveUpcoming=saveUpcoming;window.loadUpcomingAdm=loadUpcomingAdm;window.editUpcoming=editUpcoming;window.delUpcoming=delUpcoming;

// â•â•â• íŒì—…ê´€ë¦¬ â•â•â•
let _ppTab='common';
const _ppLabels={common:'ê³µí†µ(ì „ì²´)',free_user:'ë¬´ë£ŒíšŒì›',user:'ì¼ë°˜íšŒì›',jarvia_member:'JARVIAë©¤ë²„ì‹­',inner_circle:'ì´ë„ˆì„œí´',branch_manager:'ì§€ì‚¬ì¥'};
function switchPopupTab(role,btn){_ppTab=role;document.querySelectorAll('#popup-tabs .tab').forEach(t=>t.classList.remove('active'));if(btn)btn.classList.add('active');loadPopupData(role);}
async function loadPopups(){loadPopupData(_ppTab);}
async function loadPopupData(role){
  try{const d=await getDoc(doc(db,'login_popups',role));
    if(d.exists()){const p=d.data();$('pp-title').value=p.title||'';$('pp-body').innerHTML=p.bodyHtml||'';$('pp-active').value=p.isActive?'1':'0';$('pp-start').value=p.startDate||'';$('pp-end').value=p.endDate||'';
      $('pp-status').innerHTML=`<span style="color:var(--success)">âœ“ ë“±ë¡ë¨</span> | ëŒ€ìƒ: ${_ppLabels[role]||role} | ê¸°ê°„: ${p.startDate||'ì‹œì‘ì¼ ì—†ìŒ'} ~ ${p.endDate||'ë§Œë£Œì¼ ì—†ìŒ'}`;
    }else{$('pp-title').value='';$('pp-body').innerHTML='';$('pp-active').value='1';$('pp-start').value='';$('pp-end').value='';
      $('pp-status').innerHTML=`<span style="color:var(--text-lt)">ë“±ë¡ëœ íŒì—… ì—†ìŒ (${_ppLabels[role]||role})</span>`;}
    $('pp-preview').style.display='none';
  }catch(e){toast('íŒì—… ë¡œë“œ ì˜¤ë¥˜: '+e.message,'error');}
}
async function savePopup(){
  const title=$('pp-title').value.trim();const bodyHtml=$('pp-body').innerHTML.trim();const bodyText=$('pp-body').innerText.trim();
  if(!title||!bodyText){toast('ì œëª©ê³¼ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.','error');return;}
  if(!$('pp-end').value){toast('ê²Œì‹œë§Œë£Œì¼ì„ ì…ë ¥í•˜ì„¸ìš”.','error');return;}
  try{await setDoc(doc(db,'login_popups',_ppTab),{title,bodyHtml,isActive:$('pp-active').value==='1',startDate:$('pp-start').value||null,endDate:$('pp-end').value,updatedBy:admUser.uid,updatedAt:serverTimestamp()});
    toast(_ppLabels[_ppTab]+' íŒì—… ì €ì¥ ì™„ë£Œ','success');loadPopupData(_ppTab);
  }catch(e){toast('ì €ì¥ ì‹¤íŒ¨: '+e.message,'error');}
}
async function deletePopup(){
  if(!confirm(_ppLabels[_ppTab]+' íŒì—…ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?'))return;
  try{await deleteDoc(doc(db,'login_popups',_ppTab));toast('ì‚­ì œ ì™„ë£Œ','success');loadPopupData(_ppTab);}catch(e){toast('ì‚­ì œ ì‹¤íŒ¨: '+e.message,'error');}
}
function ppPreview(){$('pp-preview-body').innerHTML=$('pp-body').innerHTML;$('pp-preview').style.display='block';}
window.switchPopupTab=switchPopupTab;window.loadPopups=loadPopups;window.savePopup=savePopup;window.deletePopup=deletePopup;window.ppPreview=ppPreview;

// â•â•â• PPT ìƒì„± ê´€ë¦¬ â•â•â•
let _pgList=[];
async function loadPptGenAdmin(){
  const tb=$('tb-pptgen');
  tb.innerHTML='<tr><td colspan="8" style="text-align:center;padding:20px;color:var(--text-lt)">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td></tr>';
  try{
    const constraints=[orderBy('createdAt','desc')];
    const f=$('pg-from').value,t=$('pg-to').value;
    if(f)constraints.push(where('createdAt','>=',Timestamp.fromDate(new Date(f))));
    if(t){const td=new Date(t);td.setHours(23,59,59,999);constraints.push(where('createdAt','<=',Timestamp.fromDate(td)));}
    const stFilter=$('pg-status-filter').value;
    if(stFilter)constraints.push(where('status','==',stFilter));
    constraints.push(limit(200));
    const snap=await getDocs(query(collection(db,'pptgen_jobs'),...constraints));
    _pgList=snap.docs.map(d=>({_id:d.id,...d.data()}));
    // ì‚¬ìš©ì ì´ë¦„ ìºì‹œ
    const uc={};
    for(const j of _pgList){
      if(!uc[j.userId]){
        try{const u=await getDoc(doc(db,'users',j.userId));uc[j.userId]=u.exists()?u.data().name:j.userId;}
        catch(e){uc[j.userId]=j.userId;}
      }
    }
    // ëŒ€ì‹œë³´ë“œ í†µê³„
    const today=new Date();today.setHours(0,0,0,0);
    let todayCount=0,todayRev=0,totalDone=0,totalFail=0;
    const now=new Date();
    for(const j of _pgList){
      const cd=j.createdAt?.toDate?j.createdAt.toDate():null;
      if(cd&&cd>=today){todayCount++;if(j.paymentStatus==='confirmed')todayRev+=(j.genPrice||0);}
      if(j.status==='completed')totalDone++;
      if(j.status==='failed')totalFail++;
    }
    $('pg-today').textContent=todayCount;
    $('pg-rev').textContent=fmt(todayRev);
    $('pg-total').textContent=totalDone;
    $('pg-fail').textContent=totalFail;
    // í…Œì´ë¸” ë Œë”ë§
    const stMap={pending:'â³ ëŒ€ê¸°',processing:'ğŸ”„ ìƒì„±ì¤‘',completed:'âœ… ì™„ë£Œ',failed:'âŒ ì‹¤íŒ¨'};
    const payMap={hold:'ğŸŸ¡ ëŒ€ê¸°',confirmed:'ğŸŸ¢ í™•ì •',refunded:'ğŸ”µ í™˜ë¶ˆ'};
    if(!_pgList.length){
      tb.innerHTML='<tr><td colspan="8" style="text-align:center;padding:20px;color:var(--text-lt)">PPT ìƒì„± ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';return;
    }
    tb.innerHTML=_pgList.map(j=>{
      const title=j.formData?.ptTitle||'-';
      const tp=j.clientType==='personal'?'ğŸ‘¤ ê°œì¸':'ğŸ¢ ê¸°ì—…';
      const st=stMap[j.status]||j.status;
      const cost=j.genPrice>0?fmt(j.genPrice)+'ì›':'ë¬´ë£Œ';
      const pay=payMap[j.paymentStatus]||j.paymentStatus||'-';
      let remainStr='â€”';
      if(j.status==='completed'&&j.createdAt){
        const created=j.createdAt.toDate?j.createdAt.toDate():new Date();
        const expires=new Date(created.getTime()+7*24*60*60*1000);
        const remain=Math.ceil((expires-now)/(1000*60*60*24));
        remainStr=remain>0?`<span style="color:${remain<=2?'var(--danger)':'var(--success)'}">D-${remain}</span>`:'<span style="color:var(--text-lt)">ë§Œë£Œ</span>';
      }
      return`<tr><td style="white-space:nowrap">${fdatetime(j.createdAt)}</td><td>${esc(uc[j.userId]||j.userId)}</td><td>${tp}</td><td class="ov" title="${esc(title)}">${esc(title)}</td><td>${st}</td><td style="text-align:right">${cost}</td><td>${pay}</td><td style="text-align:center">${remainStr}</td></tr>`;
    }).join('');
  }catch(e){
    tb.innerHTML=`<tr><td colspan="8" style="text-align:center;padding:20px;color:var(--danger)">ë¡œë“œ ì‹¤íŒ¨: ${e.message}</td></tr>`;
  }
}
function exportPptGenCSV(){
  if(!_pgList.length)return toast('ë°ì´í„° ì—†ìŒ','error');
  let csv='\uFEFFìƒì„±ì¼ì‹œ,ì‚¬ìš©ìID,ìœ í˜•,PTì œëª©,ìƒíƒœ,ë¹„ìš©,ê²°ì œìƒíƒœ\n';
  _pgList.forEach(j=>{
    csv+=`${fdatetime(j.createdAt)},${j.userId},${j.clientType==='personal'?'ê°œì¸':'ê¸°ì—…'},"${(j.formData?.ptTitle||'').replace(/"/g,'""')}",${j.status},${j.genPrice||0},${j.paymentStatus||''}\n`;
  });
  const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
  const a=document.createElement('a');a.href=URL.createObjectURL(blob);
  a.download='pptgen_logs_'+new Date().toISOString().slice(0,10)+'.csv';a.click();
}
window.loadPptGenAdmin=loadPptGenAdmin;window.exportPptGenCSV=exportPptGenCSV;

// â•â•â• ê²°ì œ/ì´ìš©ë¡œê·¸ ë˜í¼ (ê¸°ì¡´ + PPT) â•â•â•
function loadPaysAll(){loadPays();loadPaysPptGen().catch(e=>console.warn('PPTê²°ì œë¡œë“œì‹¤íŒ¨:',e));}
function loadLogsAll(){loadLogs();loadLogsPptGen().catch(e=>console.warn('PPTë¡œê·¸ë¡œë“œì‹¤íŒ¨:',e));}

// â•â•â• ê²°ì œê´€ë¦¬ - PPT ê²°ì œ ë‚´ì—­ â•â•â•
async function loadPaysPptGen(){
  const tb=$('tb-pays-pptgen');
  tb.innerHTML='<tr><td colspan="5" style="text-align:center;color:var(--text-lt)">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td></tr>';
  try{
    const snap=await getDocs(query(collection(db,'pptgen_jobs'),orderBy('createdAt','desc'),limit(100)));
    if(snap.empty){tb.innerHTML='<tr><td colspan="5" style="text-align:center;color:var(--text-lt)">PPT ê²°ì œ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';return;}
    const uc={};const payMap={hold:'ğŸŸ¡ ëŒ€ê¸°',confirmed:'ğŸŸ¢ í™•ì •',refunded:'ğŸ”µ í™˜ë¶ˆ'};
    const rows=[];
    for(const d of snap.docs){
      const j=d.data();
      if(!j.genPrice||j.genPrice<=0)continue;
      if(!uc[j.userId]){try{const u=await getDoc(doc(db,'users',j.userId));uc[j.userId]=u.exists()?u.data().name:j.userId;}catch(e){uc[j.userId]=j.userId;}}
      rows.push(`<tr><td style="white-space:nowrap">${fdatetime(j.createdAt)}</td><td>${esc(uc[j.userId])}</td><td class="ov">${esc(j.formData?.ptTitle||'-')}</td><td style="text-align:right">${fmt(j.genPrice)}ì›</td><td>${payMap[j.paymentStatus]||j.paymentStatus||'-'}</td></tr>`);
    }
    tb.innerHTML=rows.length?rows.join(''):'<tr><td colspan="5" style="text-align:center;color:var(--text-lt)">ìœ ë£Œ PPT ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
  }catch(e){tb.innerHTML=`<tr><td colspan="5" style="text-align:center;color:var(--danger)">ë¡œë“œ ì‹¤íŒ¨</td></tr>`;}
}

// â•â•â• ì´ìš©ë¡œê·¸ - PPT ìƒì„± ë¡œê·¸ â•â•â•
async function loadLogsPptGen(){
  const tb=$('tb-logs-pptgen');const sumEl=$('lg-pptgen-summary');
  tb.innerHTML='<tr><td colspan="6" style="text-align:center;color:var(--text-lt)">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td></tr>';
  try{
    const constraints=[orderBy('createdAt','desc')];
    const f=$('lg-from').value,t=$('lg-to').value;
    if(f)constraints.push(where('createdAt','>=',Timestamp.fromDate(new Date(f))));
    if(t){const td=new Date(t);td.setHours(23,59,59,999);constraints.push(where('createdAt','<=',Timestamp.fromDate(td)));}
    constraints.push(limit(200));
    const snap=await getDocs(query(collection(db,'pptgen_jobs'),...constraints));
    if(snap.empty){
      tb.innerHTML='<tr><td colspan="6" style="text-align:center;color:var(--text-lt)">PPT ìƒì„± ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
      sumEl.innerHTML='';return;
    }
    const uc={};let totalCount=0,totalRev=0;const rows=[];
    const stMap={pending:'â³ ëŒ€ê¸°',processing:'ğŸ”„ ìƒì„±ì¤‘',completed:'âœ… ì™„ë£Œ',failed:'âŒ ì‹¤íŒ¨'};
    for(const d of snap.docs){
      const j=d.data();totalCount++;
      if(j.paymentStatus==='confirmed')totalRev+=(j.genPrice||0);
      if(!uc[j.userId]){try{const u=await getDoc(doc(db,'users',j.userId));uc[j.userId]=u.exists()?u.data().name:j.userId;}catch(e){uc[j.userId]=j.userId;}}
      const tp=j.clientType==='personal'?'ğŸ‘¤ ê°œì¸':'ğŸ¢ ê¸°ì—…';
      const cost=j.genPrice>0&&j.paymentStatus==='confirmed'?fmt(j.genPrice)+'ì›':(j.paymentStatus==='refunded'?'í™˜ë¶ˆ':'ë¬´ë£Œ');
      rows.push(`<tr><td style="white-space:nowrap">${fdatetime(j.createdAt)}</td><td>${esc(uc[j.userId])}</td><td>${tp}</td><td class="ov">${esc(j.formData?.ptTitle||'-')}</td><td>${stMap[j.status]||j.status}</td><td style="text-align:right">${cost}</td></tr>`);
    }
    sumEl.innerHTML=`<div class="dash-c" style="border-left-color:#E65100"><span>PPT ìƒì„±ìˆ˜</span><strong>${totalCount}</strong></div><div class="dash-c" style="border-left-color:#E65100"><span>PPT ë§¤ì¶œ</span><strong>${fmt(totalRev)}</strong><em>ì›</em></div>`;
    tb.innerHTML=rows.join('');
  }catch(e){
    tb.innerHTML=`<tr><td colspan="6" style="text-align:center;color:var(--danger)">ë¡œë“œ ì‹¤íŒ¨</td></tr>`;
    sumEl.innerHTML='';
  }
}
</script>
</body>
</html>
